<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑测试用例 - Intent Test Framework</title>
    <link rel="stylesheet" href="assets/css/minimal-style.css">
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">Intent Test Framework</div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">仪表板</a>
                <a href="testcases.html" class="nav-link active">测试用例</a>
                <a href="execution.html" class="nav-link">执行控制台</a>
                <a href="reports.html" class="nav-link">报告</a>
            </div>
            <div class="nav-user">用户</div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="main-container">
        <!-- 页面标题 -->
        <div class="page-header">
            <h1 class="page-title">编辑测试用例</h1>
            <p class="page-subtitle">修改测试用例的基本信息和执行步骤</p>
        </div>

        <!-- 基本信息 -->
        <div class="card mb-3">
            <div class="card-title">基本信息</div>
            <div class="card-subtitle">测试用例的基本属性和描述</div>
            
            <div class="grid grid-cols-3 gap-2" style="margin-bottom: 6px;">
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">用例名称</label>
                    <input type="text" class="form-input" value="用户登录功能测试" placeholder="请输入用例名称">
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">分类</label>
                    <select class="form-select">
                        <option>功能测试</option>
                        <option>性能测试</option>
                        <option>安全测试</option>
                        <option>兼容性测试</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">优先级</label>
                    <select class="form-select">
                        <option>高</option>
                        <option>中</option>
                        <option>低</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2" style="margin-bottom: 6px;">
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">状态</label>
                    <select class="form-select">
                        <option>活跃</option>
                        <option>暂停</option>
                        <option>草稿</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">标签</label>
                    <input type="text" class="form-input" value="登录,用户,验证" placeholder="用逗号分隔">
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: 2px;">创建者</label>
                    <input type="text" class="form-input" value="admin" readonly>
                </div>
            </div>

            <div style="margin-bottom: 0;">
                <label class="form-label" style="margin-bottom: 2px;">用例描述</label>
                <textarea class="form-textarea" style="min-height: 40px;" placeholder="请输入用例描述">测试用户登录功能的完整流程，包括输入验证、登录验证和页面跳转</textarea>
            </div>
        </div>

        <!-- 操作栏 -->
        <div class="card mb-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button class="btn btn-primary">保存用例</button>
                    <button class="btn btn-ghost">取消编辑</button>
                    <button class="btn btn-ghost">预览执行</button>
                </div>
                <div class="text-sm text-gray-600">
                    最后修改: 2024-01-15 14:32 • 5个步骤 • 执行156次 • 成功率94.2%
                </div>
            </div>
        </div>

        <!-- 主要编辑区域 -->
        <div class="grid gap-3" style="grid-template-columns: 3fr 1fr;">
            <!-- 左侧：步骤列表 -->
            <div class="card">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <div class="card-title">执行步骤</div>
                        <div class="card-subtitle">拖拽右侧步骤类型到此处，点击步骤可编辑详细参数</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">共 5 个步骤</span>
                        <button class="btn btn-primary btn-small">添加步骤</button>
                    </div>
                </div>

                <div class="list" style="min-height: 400px;">
                    <div class="list-item" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 1: 导航到登录页面</div>
                            <div class="list-item-subtitle">navigate • 访问 https://example.com/login</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: navigate</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">目标URL: https://example.com/login</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>

                    <div class="list-item" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 2: 输入用户名</div>
                            <div class="list-item-subtitle">ai_input • 在用户名输入框中输入 "testuser"</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: ai_input</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">定位描述: 用户名输入框</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>

                    <div class="list-item" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 3: 输入密码</div>
                            <div class="list-item-subtitle">ai_input • 在密码输入框中输入密码</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: ai_input</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">定位描述: 密码输入框</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>

                    <div class="list-item" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 4: 点击登录按钮</div>
                            <div class="list-item-subtitle">ai_tap • 点击登录按钮</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: ai_tap</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">定位描述: 登录按钮</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>

                    <div class="list-item" style="cursor: pointer;">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 5: 验证登录成功</div>
                            <div class="list-item-subtitle">ai_assert • 验证页面显示欢迎信息</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: ai_assert</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">断言条件: 登录成功</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：步骤类型库 -->
            <div class="card" id="step-types">
                <div class="card-title">步骤类型库</div>
                <div class="card-subtitle">拖拽到左侧添加步骤</div>
                
                <!-- 导航类步骤 -->
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">导航操作</div>
                    <div class="flex flex-column gap-1">
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">navigate</div>
                                <div class="text-xs text-gray-500">导航到页面</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">refresh</div>
                                <div class="text-xs text-gray-500">刷新页面</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">back</div>
                                <div class="text-xs text-gray-500">返回上一页</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交互类步骤 -->
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">交互操作</div>
                    <div class="flex flex-column gap-1">
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_input</div>
                                <div class="text-xs text-gray-500">AI输入文本</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_tap</div>
                                <div class="text-xs text-gray-500">AI点击元素</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_select</div>
                                <div class="text-xs text-gray-500">AI选择选项</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_upload</div>
                                <div class="text-xs text-gray-500">AI上传文件</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 验证类步骤 -->
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">验证操作</div>
                    <div class="flex flex-column gap-1">
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_assert</div>
                                <div class="text-xs text-gray-500">AI断言验证</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_wait</div>
                                <div class="text-xs text-gray-500">等待元素出现</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_check</div>
                                <div class="text-xs text-gray-500">检查元素状态</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作类步骤 -->
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">其他操作</div>
                    <div class="flex flex-column gap-1">
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_scroll</div>
                                <div class="text-xs text-gray-500">AI滚动页面</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">ai_drag</div>
                                <div class="text-xs text-gray-500">AI拖拽元素</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">sleep</div>
                                <div class="text-xs text-gray-500">等待指定时间</div>
                            </div>
                        </div>
                        <div class="btn btn-small btn-ghost text-left" style="justify-content: flex-start; cursor: grab;">
                            <div>
                                <div class="text-sm font-medium">screenshot</div>
                                <div class="text-xs text-gray-500">截图保存</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 调试信息 -->
        <div class="card mt-4">
            <div class="card-title">调试信息</div>
            <div class="card-subtitle">测试用例的技术信息和历史记录</div>
            
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <div class="text-sm text-gray-600 mb-1">用例ID</div>
                    <div class="text-sm font-medium">TC-001</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">创建时间</div>
                    <div class="text-sm font-medium">2024-01-15 10:30:25</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">最后修改</div>
                    <div class="text-sm font-medium">2024-01-15 14:32:15</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">创建者</div>
                    <div class="text-sm font-medium">admin</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 交互逻辑
        document.addEventListener('DOMContentLoaded', function() {
            const stepsList = document.querySelector('.list');
            const stepTypes = document.querySelectorAll('#step-types .btn-small');
            let editingStep = null;
            
            // 步骤数据（模拟数据）
            const stepsData = [
                {
                    id: 1,
                    title: '导航到登录页面',
                    action: 'navigate',
                    description: '访问 https://example.com/login 页面',
                    params: { url: 'https://example.com/login' },
                    required: true
                },
                {
                    id: 2,
                    title: '输入用户名',
                    action: 'ai_input',
                    description: '在用户名输入框中输入 "testuser"',
                    params: { text: 'testuser', locate: '用户名输入框' },
                    required: true
                },
                {
                    id: 3,
                    title: '输入密码',
                    action: 'ai_input',
                    description: '在密码输入框中输入密码',
                    params: { text: 'password123', locate: '密码输入框' },
                    required: true
                },
                {
                    id: 4,
                    title: '点击登录按钮',
                    action: 'ai_tap',
                    description: '点击登录按钮',
                    params: { locate: '登录按钮' },
                    required: true
                },
                {
                    id: 5,
                    title: '验证登录成功',
                    action: 'ai_assert',
                    description: '验证页面显示欢迎信息',
                    params: { condition: '登录成功' },
                    required: true
                }
            ];

            // 渲染步骤列表
            function renderSteps() {
                stepsList.innerHTML = '';
                stepsData.forEach((step, index) => {
                    const stepElement = createStepElement(step, index);
                    stepsList.appendChild(stepElement);
                });
            }

            // 创建步骤元素
            function createStepElement(step, index) {
                const div = document.createElement('div');
                div.className = 'step-container';
                div.innerHTML = `
                    <div class="list-item" data-step-id="${step.id}">
                        <div class="list-item-content">
                            <div class="list-item-title">步骤 ${index + 1}: ${step.title}</div>
                            <div class="list-item-subtitle">${step.action} • ${getActionDescription(step.action, step.params)}</div>
                            <div class="list-item-meta">
                                <span class="text-gray-600">动作类型: ${step.action}</span>
                                <span class="text-gray-400">•</span>
                                <span class="text-gray-600">${getMainParam(step.action, step.params)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-small btn-ghost move-up">↑</button>
                            <button class="btn btn-small btn-ghost move-down">↓</button>
                            <button class="btn btn-small btn-ghost edit-step">编辑</button>
                            <button class="btn btn-small btn-ghost duplicate-step">复制</button>
                            <button class="btn btn-small btn-ghost delete-step">删除</button>
                        </div>
                    </div>
                `;
                return div;
            }

            // 创建行内编辑表单
            function createInlineEditForm(step, index) {
                const editForm = document.createElement('div');
                editForm.className = 'inline-edit-form';
                editForm.style.cssText = `
                    background: #f8f8f8;
                    border: 1px solid #e8e8e8;
                    border-radius: 4px;
                    padding: 16px;
                    margin-top: 8px;
                    animation: slideDown 0.2s ease;
                `;
                
                editForm.innerHTML = `
                    <div class="form-edit-header" style="margin-bottom: 12px;">
                        <div style="font-weight: 500; color: #333;">编辑步骤 ${index + 1}</div>
                        <div style="font-size: 12px; color: #666;">修改步骤的详细参数</div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2" style="margin-bottom: 12px;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">步骤名称</label>
                            <input type="text" class="form-input" id="edit-title" value="${step.title}" placeholder="请输入步骤名称">
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">动作类型</label>
                            <select class="form-select" id="edit-action">
                                <option value="navigate" ${step.action === 'navigate' ? 'selected' : ''}>navigate</option>
                                <option value="ai_input" ${step.action === 'ai_input' ? 'selected' : ''}>ai_input</option>
                                <option value="ai_tap" ${step.action === 'ai_tap' ? 'selected' : ''}>ai_tap</option>
                                <option value="ai_assert" ${step.action === 'ai_assert' ? 'selected' : ''}>ai_assert</option>
                                <option value="ai_wait" ${step.action === 'ai_wait' ? 'selected' : ''}>ai_wait</option>
                                <option value="ai_scroll" ${step.action === 'ai_scroll' ? 'selected' : ''}>ai_scroll</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">必需步骤</label>
                            <select class="form-select" id="edit-required">
                                <option value="true" ${step.required ? 'selected' : ''}>是</option>
                                <option value="false" ${!step.required ? 'selected' : ''}>否</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label class="form-label" style="margin-bottom: 4px;">步骤描述</label>
                        <textarea class="form-textarea" id="edit-description" style="min-height: 60px;" placeholder="请输入步骤的详细描述">${step.description}</textarea>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label" style="margin-bottom: 4px;">动作参数 (JSON)</label>
                        <textarea class="form-textarea" id="edit-params" style="font-family: 'SF Mono', Monaco, monospace; font-size: 13px; min-height: 80px;" placeholder="请输入动作参数的JSON格式">${JSON.stringify(step.params, null, 2)}</textarea>
                    </div>

                    <div class="flex gap-2">
                        <button class="btn btn-primary save-step">保存步骤</button>
                        <button class="btn btn-ghost cancel-edit">取消编辑</button>
                        <button class="btn btn-ghost delete-step-inline">删除步骤</button>
                    </div>
                `;
                
                return editForm;
            }

            // 获取动作描述
            function getActionDescription(action, params) {
                switch(action) {
                    case 'navigate':
                        return `访问 ${params.url || '未指定URL'}`;
                    case 'ai_input':
                        return `在 "${params.locate || '未指定位置'}" 输入 "${params.text || '未指定文本'}"`;
                    case 'ai_tap':
                        return `点击 "${params.locate || '未指定元素'}"`;
                    case 'ai_assert':
                        return `验证 "${params.condition || '未指定条件'}"`;
                    case 'ai_wait':
                        return `等待 "${params.locate || '未指定元素'}" 出现`;
                    default:
                        return JSON.stringify(params);
                }
            }

            // 获取主要参数
            function getMainParam(action, params) {
                switch(action) {
                    case 'navigate':
                        return `目标URL: ${params.url || '未指定'}`;
                    case 'ai_input':
                        return `定位描述: ${params.locate || '未指定'}`;
                    case 'ai_tap':
                    case 'ai_assert':
                    case 'ai_wait':
                        return `定位描述: ${params.locate || params.condition || '未指定'}`;
                    default:
                        return Object.keys(params).length > 0 ? Object.keys(params)[0] + ': ' + params[Object.keys(params)[0]] : '无参数';
                }
            }

            // 显示行内编辑表单
            function showInlineEdit(stepContainer, stepIndex) {
                // 关闭其他编辑表单
                document.querySelectorAll('.inline-edit-form').forEach(form => {
                    form.remove();
                });
                
                const step = stepsData[stepIndex];
                const editForm = createInlineEditForm(step, stepIndex);
                stepContainer.appendChild(editForm);
                
                // 绑定编辑表单事件
                bindEditFormEvents(editForm, stepIndex);
                
                editingStep = stepIndex;
            }

            // 绑定编辑表单事件
            function bindEditFormEvents(editForm, stepIndex) {
                const saveBtn = editForm.querySelector('.save-step');
                const cancelBtn = editForm.querySelector('.cancel-edit');
                const deleteBtn = editForm.querySelector('.delete-step-inline');
                
                saveBtn.addEventListener('click', function() {
                    const title = editForm.querySelector('#edit-title').value;
                    const action = editForm.querySelector('#edit-action').value;
                    const description = editForm.querySelector('#edit-description').value;
                    const required = editForm.querySelector('#edit-required').value === 'true';
                    
                    try {
                        const params = JSON.parse(editForm.querySelector('#edit-params').value);
                        
                        // 更新步骤数据
                        stepsData[stepIndex] = {
                            ...stepsData[stepIndex],
                            title,
                            action,
                            description,
                            params,
                            required
                        };
                        
                        // 重新渲染步骤列表
                        renderSteps();
                        editingStep = null;
                        
                        console.log('步骤保存成功:', stepsData[stepIndex]);
                    } catch (e) {
                        alert('参数格式错误，请输入有效的JSON');
                    }
                });
                
                cancelBtn.addEventListener('click', function() {
                    editForm.remove();
                    editingStep = null;
                });
                
                deleteBtn.addEventListener('click', function() {
                    if (confirm('确定要删除这个步骤吗？')) {
                        stepsData.splice(stepIndex, 1);
                        renderSteps();
                        editingStep = null;
                    }
                });
            }

            // 绑定步骤操作事件
            function bindStepEvents() {
                document.querySelectorAll('.step-container').forEach((container, index) => {
                    const listItem = container.querySelector('.list-item');
                    const editBtn = container.querySelector('.edit-step');
                    const moveUpBtn = container.querySelector('.move-up');
                    const moveDownBtn = container.querySelector('.move-down');
                    const duplicateBtn = container.querySelector('.duplicate-step');
                    const deleteBtn = container.querySelector('.delete-step');
                    
                    // 编辑按钮
                    editBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showInlineEdit(container, index);
                    });
                    
                    // 上移按钮
                    moveUpBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (index > 0) {
                            [stepsData[index], stepsData[index - 1]] = [stepsData[index - 1], stepsData[index]];
                            renderSteps();
                        }
                    });
                    
                    // 下移按钮
                    moveDownBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (index < stepsData.length - 1) {
                            [stepsData[index], stepsData[index + 1]] = [stepsData[index + 1], stepsData[index]];
                            renderSteps();
                        }
                    });
                    
                    // 复制按钮
                    duplicateBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const stepCopy = JSON.parse(JSON.stringify(stepsData[index]));
                        stepCopy.id = Date.now();
                        stepCopy.title = stepCopy.title + ' (复制)';
                        stepsData.splice(index + 1, 0, stepCopy);
                        renderSteps();
                    });
                    
                    // 删除按钮
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('确定要删除这个步骤吗？')) {
                            stepsData.splice(index, 1);
                            renderSteps();
                        }
                    });
                });
            }

            // 步骤类型点击添加
            stepTypes.forEach(type => {
                type.addEventListener('click', function() {
                    const stepType = this.querySelector('div div').textContent;
                    const newStep = {
                        id: Date.now(),
                        title: getDefaultTitle(stepType),
                        action: stepType,
                        description: getDefaultDescription(stepType),
                        params: getDefaultParams(stepType),
                        required: true
                    };
                    
                    stepsData.push(newStep);
                    renderSteps();
                });
            });

            // 获取默认标题
            function getDefaultTitle(action) {
                const titles = {
                    'navigate': '导航到页面',
                    'ai_input': 'AI输入文本',
                    'ai_tap': 'AI点击元素',
                    'ai_assert': 'AI断言验证',
                    'ai_wait': '等待元素出现',
                    'ai_scroll': 'AI滚动页面'
                };
                return titles[action] || action;
            }

            // 获取默认描述
            function getDefaultDescription(action) {
                const descriptions = {
                    'navigate': '访问指定URL',
                    'ai_input': '在指定位置输入文本',
                    'ai_tap': '点击指定元素',
                    'ai_assert': '验证指定条件',
                    'ai_wait': '等待指定元素出现',
                    'ai_scroll': '滚动页面'
                };
                return descriptions[action] || '执行' + action + '操作';
            }

            // 获取默认参数
            function getDefaultParams(action) {
                const defaults = {
                    'navigate': { url: 'https://example.com' },
                    'ai_input': { text: '', locate: '输入框' },
                    'ai_tap': { locate: '按钮' },
                    'ai_assert': { condition: '页面内容' },
                    'ai_wait': { locate: '元素', timeout: 10000 },
                    'ai_scroll': { direction: 'down' }
                };
                return defaults[action] || {};
            }

            // 初始化
            renderSteps();
            
            // 渲染后绑定事件
            const observer = new MutationObserver(function(mutations) {
                bindStepEvents();
            });
            observer.observe(stepsList, { childList: true });
            
            // 初始绑定
            bindStepEvents();

            // 主要操作按钮
            document.querySelector('.btn-primary').addEventListener('click', function() {
                console.log('保存测试用例', stepsData);
            });

            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.inline-edit-form').forEach(form => {
                        form.remove();
                    });
                    editingStep = null;
                }
            });
        });
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>