# STORY-008: å®ç°å˜é‡å¼•ç”¨è¯­æ³•è§£æ

**Story ID**: STORY-008  
**Epic**: EPIC-001 æ•°æ®æµæ ¸å¿ƒåŠŸèƒ½  
**Sprint**: Sprint 2  
**ä¼˜å…ˆçº§**: High  
**ä¼°ç®—**: 8 Story Points  
**åˆ†é…ç»™**: Backend Developer + å…¨æ ˆå·¥ç¨‹å¸ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-30  
**äº§å“ç»ç†**: John  

---

## ğŸ“– æ•…äº‹æè¿°

**ä½œä¸º** æµ‹è¯•å·¥ç¨‹å¸ˆ  
**æˆ‘å¸Œæœ›** åœ¨æµ‹è¯•æ­¥éª¤çš„å‚æ•°ä¸­ä½¿ç”¨`${variable_name}`å’Œ`${variable.property}`è¯­æ³•  
**ä»¥ä¾¿** æˆ‘å¯ä»¥å¼•ç”¨ä¹‹å‰æ­¥éª¤å­˜å‚¨çš„å˜é‡æ•°æ®  
**è¿™æ ·** æˆ‘å°±èƒ½åˆ›å»ºåŠ¨æ€çš„ã€æ•°æ®é©±åŠ¨çš„æµ‹è¯•æµç¨‹ï¼Œæ­¥éª¤é—´å¯ä»¥ä¼ é€’å’Œä½¿ç”¨æ•°æ®  

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### AC-1: åŸºç¡€å˜é‡å¼•ç”¨è¯­æ³•æ”¯æŒ
**ç»™å®š** æˆ‘åœ¨æ­¥éª¤å‚æ•°ä¸­ä½¿ç”¨`${variable_name}`è¯­æ³•  
**å½“** ç³»ç»Ÿæ‰§è¡Œè¯¥æ­¥éª¤æ—¶  
**é‚£ä¹ˆ** å˜é‡å¼•ç”¨åº”è¯¥è¢«æ­£ç¡®è§£æä¸ºå®é™…çš„å˜é‡å€¼  

**ç¤ºä¾‹**:
```json
{
  "action": "ai_input",
  "params": {
    "text": "æœç´¢${product_name}",
    "locate": "æœç´¢æ¡†"
  }
}
```

### AC-2: å¯¹è±¡å±æ€§è®¿é—®è¯­æ³•æ”¯æŒ
**ç»™å®š** æˆ‘ä½¿ç”¨`${variable.property}`è¯­æ³•å¼•ç”¨å¯¹è±¡å±æ€§  
**å½“** ç³»ç»Ÿè§£æå˜é‡å¼•ç”¨æ—¶  
**é‚£ä¹ˆ** åº”è¯¥æ­£ç¡®æå–å¯¹è±¡ä¸­çš„æŒ‡å®šå±æ€§å€¼  

**ç¤ºä¾‹**:
```json
{
  "action": "ai_assert",
  "params": {
    "condition": "ä»·æ ¼æ˜¾ç¤ºä¸º${product_info.price}å…ƒ"
  }
}
```

### AC-3: åµŒå¥—å±æ€§è®¿é—®æ”¯æŒ
**ç»™å®š** æˆ‘ä½¿ç”¨æ·±å±‚åµŒå¥—è¯­æ³•å¦‚`${user.profile.address.city}`  
**å½“** ç³»ç»Ÿè§£æå˜é‡å¼•ç”¨æ—¶  
**é‚£ä¹ˆ** åº”è¯¥æ”¯æŒæœ€å¤š5å±‚çš„åµŒå¥—å±æ€§è®¿é—®  

### AC-4: æ•°ç»„å…ƒç´ è®¿é—®æ”¯æŒ
**ç»™å®š** å˜é‡æ˜¯æ•°ç»„ç±»å‹  
**å½“** æˆ‘ä½¿ç”¨`${products[0].name}`è¯­æ³•  
**é‚£ä¹ˆ** ç³»ç»Ÿåº”è¯¥æ­£ç¡®æå–æ•°ç»„æŒ‡å®šç´¢å¼•çš„å…ƒç´   

**æ”¯æŒç‰¹æ€§**:
- æ­£æ•°ç´¢å¼•ï¼š`${items[0]}`, `${items[1]}`
- è´Ÿæ•°ç´¢å¼•ï¼š`${items[-1]}` (æœ€åä¸€ä¸ªå…ƒç´ )
- åµŒå¥—è®¿é—®ï¼š`${items[0].property}`

### AC-5: é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½æç¤º
**ç»™å®š** å˜é‡å¼•ç”¨å­˜åœ¨é—®é¢˜  
**å½“** ç³»ç»Ÿå°è¯•è§£ææ—¶  
**é‚£ä¹ˆ** åº”è¯¥æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å¹¶è®°å½•åˆ°æ—¥å¿—  

**é”™è¯¯åœºæ™¯**:
- å˜é‡ä¸å­˜åœ¨ï¼š`å˜é‡ 'unknown_var' æœªå®šä¹‰`
- å±æ€§ä¸å­˜åœ¨ï¼š`å¯¹è±¡ä¸­ä¸å­˜åœ¨å±æ€§ 'unknown_prop'`
- æ•°ç»„ç´¢å¼•è¶Šç•Œï¼š`æ•°ç»„ç´¢å¼• 5 è¶…å‡ºèŒƒå›´ (é•¿åº¦: 3)`
- ç±»å‹é”™è¯¯ï¼š`æ— æ³•åœ¨éå¯¹è±¡ç±»å‹ä¸Šè®¿é—®å±æ€§`

### AC-6: å¤šä¸ªå˜é‡å¼•ç”¨åœ¨åŒä¸€å‚æ•°ä¸­
**ç»™å®š** å•ä¸ªå‚æ•°ä¸­åŒ…å«å¤šä¸ªå˜é‡å¼•ç”¨  
**å½“** ç³»ç»Ÿè§£æå‚æ•°æ—¶  
**é‚£ä¹ˆ** æ‰€æœ‰å˜é‡å¼•ç”¨éƒ½åº”è¯¥è¢«æ­£ç¡®æ›¿æ¢  

**ç¤ºä¾‹**:
```json
{
  "action": "ai_input",
  "params": {
    "text": "${user_name}è´­ä¹°äº†${product_count}ä¸ª${product_name}"
  }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦æ±‚

### æ ¸å¿ƒå˜é‡è§£æå™¨
```python
class VariableResolver:
    def __init__(self, variable_manager: VariableManager):
        self.variable_manager = variable_manager
        self.pattern = re.compile(r'\$\{([^}]+)\}')
    
    def resolve_text(self, text: str, step_index: int = None) -> str:
        """è§£ææ–‡æœ¬ä¸­çš„æ‰€æœ‰å˜é‡å¼•ç”¨"""
        
    def resolve_variable_path(self, reference: str) -> Any:
        """è§£æå˜é‡è·¯å¾„ï¼Œæ”¯æŒåµŒå¥—å±æ€§å’Œæ•°ç»„è®¿é—®"""
        
    def validate_reference(self, reference: str) -> bool:
        """éªŒè¯å˜é‡å¼•ç”¨è¯­æ³•çš„æ­£ç¡®æ€§"""
```

### è¯­æ³•è§£æè§„åˆ™
1. **åŸºç¡€è¯­æ³•**: `${variable_name}`
2. **å±æ€§è®¿é—®**: `${object.property}`
3. **åµŒå¥—è®¿é—®**: `${object.nested.property}` (æœ€å¤š5å±‚)
4. **æ•°ç»„è®¿é—®**: `${array[index]}` æˆ– `${array[index].property}`
5. **æ··åˆä½¿ç”¨**: `${data.items[0].name}`

### æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
```python
# åŒ¹é… ${...} æ ¼å¼çš„å˜é‡å¼•ç”¨
VARIABLE_PATTERN = r'\$\{([^}]+)\}'

# è§£æå˜é‡è·¯å¾„çš„å­æ¨¡å¼
PATH_PATTERN = r'^([a-zA-Z_][a-zA-Z0-9_]*)((?:\.[a-zA-Z_][a-zA-Z0-9_]*|\[\d+\]|\[-\d+\])*)$'
```

### é”™è¯¯å¤„ç†ç­–ç•¥
```python
class VariableResolutionError(Exception):
    def __init__(self, reference: str, reason: str, step_index: int = None):
        self.reference = reference
        self.reason = reason
        self.step_index = step_index
        super().__init__(f"å˜é‡å¼•ç”¨é”™è¯¯ '{reference}': {reason}")
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•åœºæ™¯
1. **åŸºç¡€å˜é‡å¼•ç”¨æµ‹è¯•**
   ```python
   def test_simple_variable_reference():
       # æµ‹è¯• ${var_name} æ ¼å¼
       assert resolver.resolve_text("Hello ${name}") == "Hello World"
   ```

2. **å¯¹è±¡å±æ€§è®¿é—®æµ‹è¯•**
   ```python
   def test_object_property_access():
       # æµ‹è¯• ${obj.prop} æ ¼å¼
       assert resolver.resolve_text("Price: ${product.price}") == "Price: 99.99"
   ```

3. **æ•°ç»„è®¿é—®æµ‹è¯•**
   ```python
   def test_array_access():
       # æµ‹è¯• ${arr[0]} æ ¼å¼
       assert resolver.resolve_text("${items[0]}") == "first_item"
       assert resolver.resolve_text("${items[-1]}") == "last_item"
   ```

4. **å¤æ‚åµŒå¥—æµ‹è¯•**
   ```python
   def test_nested_access():
       # æµ‹è¯•æ·±å±‚åµŒå¥—è®¿é—®
       assert resolver.resolve_text("${user.profile.address.city}") == "åŒ—äº¬"
   ```

5. **é”™è¯¯å¤„ç†æµ‹è¯•**
   ```python
   def test_undefined_variable_error():
       with pytest.raises(VariableResolutionError):
           resolver.resolve_text("${undefined_var}")
   ```

### é›†æˆæµ‹è¯•åœºæ™¯
1. **ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•**
   ```json
   [
     {
       "action": "aiQuery",
       "params": {"query": "æå–ç”¨æˆ·ä¿¡æ¯", "dataDemand": "{name: string, age: number}"},
       "output_variable": "user_info"
     },
     {
       "action": "ai_input",
       "params": {
         "text": "ç”¨æˆ·${user_info.name}ï¼Œå¹´é¾„${user_info.age}å²",
         "locate": "è¾“å…¥æ¡†"
       }
     }
   ]
   ```

2. **å¤æ‚æ•°æ®ç»“æ„æµ‹è¯•**
   ```json
   {
     "action": "ai_assert",
     "params": {
       "condition": "è®¢å•åŒ…å«${order.items[0].name}ï¼Œæ•°é‡${order.items[0].quantity}ä¸ª"
     }
   }
   ```

### æ€§èƒ½æµ‹è¯•
- å¤§é‡å˜é‡å¼•ç”¨çš„è§£ææ€§èƒ½
- æ·±å±‚åµŒå¥—è®¿é—®çš„æ€§èƒ½å½±å“
- å¹¶å‘è§£æçš„çº¿ç¨‹å®‰å…¨æ€§

---

## ğŸ“Š Definition of Done

- [ ] **æ ¸å¿ƒåŠŸèƒ½**: æ‰€æœ‰å˜é‡å¼•ç”¨è¯­æ³•æ­£ç¡®æ”¯æŒ
- [ ] **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ£€æµ‹å’Œç”¨æˆ·å‹å¥½æç¤º
- [ ] **æ€§èƒ½è¦æ±‚**: å˜é‡è§£æå“åº”æ—¶é—´<100ms
- [ ] **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•è¦†ç›–ç‡>95%
- [ ] **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] **æ–‡æ¡£æ›´æ–°**: å˜é‡å¼•ç”¨è¯­æ³•æ–‡æ¡£å®Œå–„
- [ ] **ä»£ç å®¡æŸ¥**: ä»£ç è´¨é‡å®¡æŸ¥é€šè¿‡
- [ ] **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ğŸ”— ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–**:
- STORY-007: output_variableå‚æ•°è§£æå’Œå­˜å‚¨ï¼ˆå¿…é¡»å…ˆæœ‰å˜é‡æ•°æ®ï¼‰
- STORY-003: VariableResolverServiceåŸºç¡€æ¶æ„

**åç»­ä¾èµ–**:
- STORY-009: é›†æˆå˜é‡è§£æåˆ°æ­¥éª¤æ‰§è¡Œæµç¨‹
- STORY-010: SmartVariableInputç»„ä»¶ï¼ˆæ™ºèƒ½æç¤ºåŠŸèƒ½ï¼‰

---

## ğŸ’¡ å®ç°æ³¨æ„äº‹é¡¹

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ç¼–è¯‘åçš„æ­£åˆ™è¡¨è¾¾å¼æå‡åŒ¹é…æ€§èƒ½
- å®ç°å˜é‡è§£æç»“æœç¼“å­˜
- é¿å…é‡å¤çš„æ·±å±‚å¯¹è±¡è®¿é—®

### å®‰å…¨è€ƒè™‘
- é˜²æ­¢æ— é™é€’å½’çš„åµŒå¥—è®¿é—®
- é™åˆ¶å˜é‡è·¯å¾„é•¿åº¦ï¼Œé˜²æ­¢æ‹’ç»æœåŠ¡æ”»å‡»
- è¾“å…¥éªŒè¯é˜²æ­¢ä»£ç æ³¨å…¥

### æ‰©å±•æ€§è®¾è®¡
- æ”¯æŒè‡ªå®šä¹‰å˜é‡å¼•ç”¨æ ¼å¼
- é¢„ç•™å˜é‡è½¬æ¢å‡½æ•°é’©å­
- æ”¯æŒå˜é‡å¼•ç”¨çš„è°ƒè¯•æ¨¡å¼

---

**çŠ¶æ€**: å¾…å¼€å§‹  
**åˆ›å»ºäºº**: John (Product Manager)  
**æœ€åæ›´æ–°**: 2025-01-30  

*æ­¤ç”¨æˆ·æ•…äº‹æ˜¯æ•°æ®æµåŠŸèƒ½çš„æ ¸å¿ƒï¼Œå®Œæˆåå°†å®ç°å®Œæ•´çš„å˜é‡å¼•ç”¨èƒ½åŠ›*