# Epic: Intent Test Framework 数据流核心功能

**Epic ID**: EPIC-001  
**创建日期**: 2025-01-30  
**产品经理**: John  
**优先级**: P0 (最高)  
**预估工期**: 3周 (15个工作日)  

---

## 📋 Epic概述

### Epic标题
实现Intent Test Framework的数据流功能，管理现有Midscene API方法的返回值，并支持步骤间变量引用

### Epic描述
作为Intent Test Framework的核心增强功能，我们需要实现数据流管理系统，捕获现有Midscene API方法的返回值（如aiQuery、aiString、aiNumber、aiBoolean等），将其存储为变量，并在后续步骤中引用这些变量。这将充分利用Midscene现有的数据提取能力，显著提升测试用例的灵活性和数据驱动能力。

### 业务价值
- **提升测试效率**: 减少重复的数据输入和验证工作
- **增强测试能力**: 支持复杂的端到端数据流测试
- **降低维护成本**: 数据驱动的测试用例更易维护和扩展
- **提升用户体验**: 为后续智能化功能奠定基础

---

## 🎯 Epic目标

### 主要目标
1. **返回值捕获**: 捕获现有Midscene API方法的返回值并存储为变量
2. **变量管理**: 返回值数据能够存储、管理和查询
3. **变量引用**: 后续步骤能够通过语法引用之前步骤的返回值
4. **基础智能提示**: 为变量引用提供基本的自动完成功能

### 成功标准
- ✅ 支持所有有返回值的Midscene API方法的输出捕获
- ✅ 变量引用语法解析准确率100%
- ✅ 智能提示响应时间<200ms
- ✅ 向后兼容100%的现有测试用例
- ✅ 核心功能测试覆盖率>90%

---

## 👥 目标用户

### 主要用户
- **测试工程师**: 创建复杂的数据驱动测试用例
- **QA团队**: 提升测试自动化覆盖率
- **开发团队**: 集成测试和回归测试场景

### 用户场景
1. **电商测试场景**: 提取商品价格→计算折扣→验证结果
2. **用户流程测试**: 提取用户信息→跨页面验证→完成流程
3. **API测试场景**: 提取响应数据→作为后续请求参数

---

## 🔧 功能需求

### 核心功能组件

#### 1. 现有Action返回值捕获
**描述**: 为现有的Midscene API Action添加返回值捕获功能

**支持返回值的Action类型**:
- `aiQuery`: 返回结构化数据 (Promise<T>)
- `aiString`: 返回字符串数据 (Promise<string>)
- `aiNumber`: 返回数字数据 (Promise<number>)
- `aiBoolean`: 返回布尔值数据 (Promise<boolean>)
- `aiAsk`: 返回AI问答结果 (Promise<string>)
- `aiLocate`: 返回元素位置信息 (Promise<{rect, center, scale}>)
- `evaluateJavaScript`: 返回JS执行结果 (Promise<any>)

**新增配置参数**:
```json
{
  "action": "aiQuery",
  "params": {
    "query": "提取商品信息",
    "dataDemand": "{name: string, price: number}"
  },
  "output_variable": "product_info",  // 新增：输出变量名
  "description": "提取商品基本信息"
}
```

**验收标准**:
- [ ] 所有有返回值的Midscene API方法支持输出捕获
- [ ] 返回值正确存储到执行上下文
- [ ] 支持复杂对象和基础数据类型
- [ ] API调用失败时有清晰的错误提示

#### 2. 变量引用系统
**描述**: 实现变量语法解析和运行时替换

**支持的语法**:
- 简单变量: `${variable_name}`
- 对象属性: `${variable_name.property}`
- 嵌套属性: `${user.profile.name}`

**核心组件**:
- VariableResolver: 变量解析引擎
- ExecutionContext: 执行上下文管理
- VariableValidator: 变量引用验证

**验收标准**:
- [ ] 支持所有定义的变量引用语法
- [ ] 运行时正确解析和替换变量
- [ ] 未定义变量时提供清晰错误提示
- [ ] 支持最多5层嵌套属性访问

#### 3. 执行上下文管理
**描述**: 管理测试执行过程中的变量生命周期

**核心功能**:
- 变量存储和检索
- 类型管理和转换
- 作用域控制
- 并发安全

**数据结构**:
```python
class ExecutionContext:
    execution_id: str
    variables: Dict[str, VariableData]
    created_at: datetime
    
class VariableData:
    name: str
    value: Any
    data_type: str
    source_step: int
    created_at: datetime
```

**验收标准**:
- [ ] 变量数据正确存储和检索
- [ ] 支持并发执行的数据隔离
- [ ] 执行结束后正确清理变量上下文
- [ ] 变量操作有完整的日志记录

#### 4. 基础智能提示
**描述**: 为变量引用提供基本的自动完成功能

**功能特性**:
- 输入`${`时触发提示菜单
- 显示可用变量列表
- 变量类型和来源信息
- 基本的键盘导航

**UI组件**:
- SmartVariableInput: 智能输入组件
- VariableSuggestionDropdown: 提示下拉菜单

**验收标准**:
- [ ] 输入触发器正确响应
- [ ] 提示内容准确且完整
- [ ] 响应时间<200ms
- [ ] 基本键盘交互功能正常

---

## 🏗️ 技术实现

### 架构组件

#### 后端组件
1. **Flask API扩展**
   - `/api/v1/executions/{id}/variables`: 变量管理API
   - `/api/v1/testcases/{id}/variable-suggestions`: 智能提示API
   - `/api/v1/steps/validate`: 参数验证API

2. **数据库Schema扩展**
   - `execution_contexts`表: 存储执行上下文变量
   - `step_executions`表扩展: 添加输出数据字段

3. **核心服务类**
   - `VariableResolverService`: 变量解析服务
   - `ExecutionContextService`: 上下文管理服务
   - `DataExtractionService`: 数据提取服务

#### 前端组件
1. **React组件**
   - `SmartVariableInput`: 智能变量输入组件
   - `VariableSuggestionDropdown`: 提示下拉组件
   - `VariableBrowser`: 变量浏览器组件

2. **状态管理**
   - 执行上下文状态管理
   - 变量数据缓存策略
   - 智能提示状态管理

#### AI引擎组件
1. **MidSceneJS集成**
   - 新增数据提取API端点
   - 数据类型推断和验证
   - 错误处理和重试机制

### 数据流设计
```
用户配置现有Action+output_variable
    ↓
执行Midscene API方法 (aiQuery/aiString/etc.)
    ↓
捕获API方法的返回值
    ↓
存储返回值到ExecutionContext
    ↓
后续步骤引用变量 (${variable_name})
    ↓
VariableResolver解析替换
    ↓
继续执行测试流程
```

---

## 📅 开发计划

### Sprint 1: 基础架构 (Week 1)
**目标**: 建立核心架构和数据模型

**Story列表**:
- **STORY-001**: 设计和实现ExecutionContext数据模型
- **STORY-002**: 创建数据库Schema迁移脚本
- **STORY-003**: 实现VariableResolverService基础功能
- **STORY-004**: 建立MidSceneJS数据提取API框架

**交付成果**:
- [ ] 数据库Schema已部署
- [ ] 核心服务类框架完成
- [ ] 基础单元测试通过

### Sprint 2: 核心功能 (Week 2)
**目标**: 实现数据提取和变量引用核心功能

**Story列表**:
- **STORY-005**: 为aiQuery/aiString/aiNumber/aiBoolean添加返回值捕获
- **STORY-006**: 为aiAsk/aiLocate/evaluateJavaScript添加返回值捕获
- **STORY-007**: 实现output_variable参数解析和存储
- **STORY-008**: 实现变量引用语法解析
- **STORY-009**: 集成变量解析到步骤执行流程

**交付成果**:
- [ ] 所有有返回值的Midscene API支持输出捕获
- [ ] 变量引用系统正常工作
- [ ] 集成测试通过

### Sprint 3: 智能提示和优化 (Week 3)
**目标**: 实现智能提示功能和系统优化

**Story列表**:
- **STORY-010**: 开发SmartVariableInput React组件
- **STORY-011**: 实现变量提示API
- **STORY-012**: 集成智能提示到测试用例编辑器
- **STORY-013**: 性能优化和错误处理
- **STORY-014**: 完整的端到端测试

**交付成果**:
- [ ] 智能提示功能完整可用
- [ ] 性能指标达到要求
- [ ] 用户验收测试通过

---

## 🧪 测试策略

### 测试层次

#### 1. 单元测试
**覆盖组件**:
- VariableResolverService
- ExecutionContextService
- 返回值捕获机制
- React智能提示组件

**测试重点**:
- 各种返回值类型的正确捕获
- 边界条件处理
- 错误场景覆盖
- 性能基准测试

#### 2. 集成测试
**测试场景**:
- 端到端数据流测试
- MidSceneJS集成测试
- 数据库操作测试
- API接口测试

#### 3. 用户验收测试
**测试用例**:
- 典型用户场景测试
- 复杂数据流场景
- 错误恢复测试
- 性能压力测试

### 测试数据
**准备测试环境**:
- 模拟网站页面数据
- 各种数据类型的测试用例
- 复杂嵌套对象数据
- 边界和异常数据

---

## 📊 验收标准

### 功能验收标准

#### 数据提取功能
- [ ] 支持string、number、boolean、object四种数据类型提取
- [ ] 数据提取成功率>95%（正常网络条件下）
- [ ] 支持自定义Schema验证
- [ ] 提取失败时错误信息清晰可操作

#### 变量引用功能
- [ ] 支持`${var}`和`${var.prop}`语法
- [ ] 变量解析准确率100%
- [ ] 支持5层嵌套属性访问
- [ ] 未定义变量提供明确错误提示

#### 智能提示功能
- [ ] 输入`${`时自动触发提示（响应时间<200ms）
- [ ] 提示内容包含变量名、类型、来源信息
- [ ] 支持键盘导航（上下箭头、Enter、ESC）
- [ ] 提示准确率>90%

### 技术验收标准

#### 性能指标
- [ ] 智能提示响应时间<200ms (P95)
- [ ] 变量解析处理时间<500ms (平均)
- [ ] 数据提取操作<10s (P90)
- [ ] 系统整体响应时间增加<10%

#### 可靠性指标
- [ ] 向后兼容100%现有测试用例
- [ ] 核心功能测试覆盖率>90%
- [ ] 错误恢复机制完整
- [ ] 并发安全验证通过

---

## 🚨 风险和缓解措施

### 技术风险

#### 1. MidSceneJS API集成复杂性
**风险等级**: 高  
**影响**: 数据提取功能不稳定  
**缓解措施**:
- 提前进行API兼容性测试
- 建立Mock服务用于开发和测试
- 准备降级方案

#### 2. 性能影响
**风险等级**: 中  
**影响**: 系统响应速度下降  
**缓解措施**:
- 实施多层缓存策略
- 异步处理非关键路径
- 持续性能监控

#### 3. 数据安全
**风险等级**: 中  
**影响**: 敏感数据泄露风险  
**缓解措施**:
- 变量数据加密存储
- 访问权限控制
- 审计日志记录

### 项目风险

#### 1. 开发资源不足
**风险等级**: 中  
**影响**: 延期交付  
**缓解措施**:
- 功能优先级明确
- 准备最小可行版本
- 及时沟通资源需求

#### 2. 用户接受度
**风险等级**: 低  
**影响**: 功能使用率低  
**缓解措施**:
- 早期用户参与测试
- 详细的用户文档
- 渐进式功能推广

---

## 📈 成功度量

### 关键指标

#### 开发阶段指标
- [ ] 开发进度按计划执行（±2天）
- [ ] 代码审查通过率>95%
- [ ] 单元测试覆盖率>90%
- [ ] 集成测试通过率100%

#### 发布后指标
- [ ] 功能使用率>50%（发布后1个月）
- [ ] 用户反馈满意度>4.0/5.0
- [ ] 系统稳定性无回归
- [ ] 错误率<1%

### 监控和度量
- **开发过程**: JIRA任务跟踪、代码审查记录
- **质量指标**: 测试覆盖率报告、性能测试结果
- **用户指标**: 使用统计、用户反馈收集

---

## 🔄 后续规划

### 依赖的后续Epic
1. **Epic-002**: 智能提示系统完善
2. **Epic-003**: 参数表单优化
3. **Epic-004**: 数据流可视化

### 技术债务
- 性能优化和缓存策略完善
- 错误处理机制统一化
- 安全加固和权限控制
- 监控和告警系统集成

---

## 📞 团队和角色

### 核心开发团队
- **Tech Lead**: 技术架构和关键决策
- **Backend Developer**: Flask API和数据处理
- **Frontend Developer**: React组件和用户界面
- **QA Engineer**: 测试策略和质量保证

### 支持团队
- **Product Manager**: 需求澄清和优先级管理
- **DevOps Engineer**: 部署和基础设施支持
- **UX Designer**: 用户体验设计和验证

### 外部依赖
- **用户代表**: 需求验证和接受度测试
- **架构师**: 技术架构指导和审查

---

## 📝 备注

### 定义完成 (Definition of Done)
- [ ] 功能代码开发完成
- [ ] 单元测试编写并通过
- [ ] 集成测试通过
- [ ] 代码审查完成
- [ ] 文档更新完成
- [ ] 用户验收测试通过
- [ ] 性能指标达标
- [ ] 安全审查通过

### 沟通计划
- **日常站会**: 每日进展同步
- **Sprint回顾**: 每周Sprint总结
- **演示会议**: 每Sprint结束演示
- **用户反馈会**: 功能完成后用户验证

---

**Epic状态**: 待开始  
**创建人**: John (Product Manager)  
**最后更新**: 2025-01-30  

*此Epic将随着开发进展持续更新和完善*