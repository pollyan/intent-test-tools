# Intent Test Framework æ•°æ®æµåŠŸèƒ½å…¨æ ˆæ¶æ„è®¾è®¡

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-30  
**æ¶æ„å¸ˆ**: Winston  
**é¡¹ç›®**: Intent Test Framework - æ•°æ®æµåŠŸèƒ½å¢å¼º  

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ„¿æ™¯
å°†Intent Test Frameworkä»é™æ€çš„æ­¥éª¤æ‰§è¡Œç³»ç»Ÿæ¼”è¿›ä¸ºæ™ºèƒ½çš„æ•°æ®é©±åŠ¨æµ‹è¯•å¹³å°ï¼Œæ”¯æŒæ­¥éª¤é—´æ•°æ®æµä¼ é€’ã€æ™ºèƒ½å˜é‡å¼•ç”¨å’Œç”¨æˆ·å‹å¥½çš„å‚æ•°é…ç½®ä½“éªŒã€‚

### æ ¸å¿ƒæ¶æ„åŸåˆ™
1. **æ¸è¿›å¼å¢å¼º**: åœ¨ç°æœ‰æ¶æ„åŸºç¡€ä¸Šå¹³æ»‘æ‰©å±•ï¼Œä¿æŒå‘åå…¼å®¹
2. **æ€§èƒ½ä¼˜å…ˆ**: æ•°æ®æµå¤„ç†ä¸å½±å“ç°æœ‰æµ‹è¯•æ‰§è¡Œæ€§èƒ½
3. **ç”¨æˆ·ä½“éªŒé©±åŠ¨**: æ™ºèƒ½æç¤ºå’Œè¡¨å•ä¼˜åŒ–æ˜¾è‘—æå‡ä½¿ç”¨ä½“éªŒ
4. **å¯æ‰©å±•è®¾è®¡**: æ¶æ„æ”¯æŒæœªæ¥æ›´å¤æ‚çš„æ•°æ®æ“ä½œéœ€æ±‚
5. **å®‰å…¨å¯é **: å˜é‡è§£æå’Œæ•°æ®ä¼ é€’å…·å¤‡å®Œæ•´çš„éªŒè¯å’Œé”™è¯¯å¤„ç†

---

## ğŸ¯ æ¶æ„ç›®æ ‡ä¸çº¦æŸ

### ä¸šåŠ¡ç›®æ ‡
- **åŠŸèƒ½ç›®æ ‡**: å®ç°æ­¥éª¤é—´æ•°æ®ä¼ é€’å’Œæ™ºèƒ½å˜é‡å¼•ç”¨
- **ä½“éªŒç›®æ ‡**: æä¾›IDEçº§åˆ«çš„æ™ºèƒ½æç¤ºå’Œè¡¨å•åŒ–å‚æ•°é…ç½®
- **æ€§èƒ½ç›®æ ‡**: æ•°æ®æµå¤„ç†å»¶è¿Ÿ < 500msï¼Œæ™ºèƒ½æç¤ºå“åº” < 200ms
- **å¯ç”¨æ€§ç›®æ ‡**: 99.9%ç³»ç»Ÿå¯ç”¨æ€§ï¼Œå‘åå…¼å®¹100%ç°æœ‰æµ‹è¯•ç”¨ä¾‹

### æŠ€æœ¯çº¦æŸ
- **ç°æœ‰æŠ€æœ¯æ ˆ**: Flask + React + PostgreSQL + MidSceneJS
- **éƒ¨ç½²ç¯å¢ƒ**: Vercel + Supabaseäº‘æœåŠ¡ + æœ¬åœ°ä»£ç†åŒ…
- **æµè§ˆå™¨æ”¯æŒ**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **æ€§èƒ½çº¦æŸ**: å•æµ‹è¯•ç”¨ä¾‹æ”¯æŒ100+å˜é‡ï¼Œ5å±‚åµŒå¥—å¯¹è±¡è®¿é—®

### éåŠŸèƒ½æ€§éœ€æ±‚
- **å¯æ‰©å±•æ€§**: æ”¯æŒ10ä¸‡+æµ‹è¯•ç”¨ä¾‹ï¼Œ1ä¸‡+å¹¶å‘æ‰§è¡Œ
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæµ‹è¯•è¦†ç›–ç‡ > 80%
- **å®‰å…¨æ€§**: å˜é‡æ•°æ®åŠ å¯†å­˜å‚¨ï¼Œè®¿é—®æƒé™æ§åˆ¶
- **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œæ€§èƒ½ç›‘æ§

---

## ğŸ›ï¸ æ•´ä½“ç³»ç»Ÿæ¶æ„

### é«˜å±‚æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚  AI Engine     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ React UI      â”‚â”€â”€â”€â”€â”‚ â€¢ Flask API     â”‚â”€â”€â”€â”€â”‚ â€¢ MidSceneJS    â”‚
â”‚ â€¢ Smart Input   â”‚    â”‚ â€¢ Variable      â”‚    â”‚ â€¢ Playwright    â”‚
â”‚ â€¢ Form Builder  â”‚    â”‚   Resolver      â”‚    â”‚ â€¢ Data Extract  â”‚
â”‚                 â”‚    â”‚ â€¢ Validation    â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Data Layer    â”‚    â”‚  Execution      â”‚    â”‚  Infrastructure â”‚
â”‚                 â”‚    â”‚  Context        â”‚    â”‚                 â”‚
â”‚ â€¢ PostgreSQL    â”‚    â”‚                 â”‚    â”‚ â€¢ Vercel        â”‚
â”‚ â€¢ Variable      â”‚â”€â”€â”€â”€â”‚ â€¢ Memory Store  â”‚    â”‚ â€¢ Supabase      â”‚
â”‚   Storage       â”‚    â”‚ â€¢ Session Mgmt  â”‚    â”‚ â€¢ Local Proxy   â”‚
â”‚ â€¢ Schema Mgmt   â”‚    â”‚ â€¢ Lifecycle     â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµæ¶æ„
```
ç”¨æˆ·è¾“å…¥ â†’ æ™ºèƒ½æç¤º â†’ å‚æ•°éªŒè¯ â†’ æ­¥éª¤æ‰§è¡Œ â†’ æ•°æ®æå– â†’ å˜é‡å­˜å‚¨ â†’ åç»­å¼•ç”¨
    â†‘         â†“         â†“         â†“         â†“         â†“         â†“
æ™ºèƒ½å»ºè®® â† UIç»„ä»¶ â† è¡¨å•ç”Ÿæˆ â† AIå¼•æ“ â† è§£æå™¨ â† ä¸Šä¸‹æ–‡ â† å˜é‡è§£æ
```

---

## ğŸ¨ å‰ç«¯æ¶æ„è®¾è®¡

### ç»„ä»¶æ¶æ„å±‚æ¬¡
```
App Level
â”œâ”€â”€ TestCaseEditor (Container)
â”‚   â”œâ”€â”€ StepList (Presentation)
â”‚   â”‚   â”œâ”€â”€ StepItem (Smart Component)
â”‚   â”‚   â”‚   â”œâ”€â”€ StepParameterForm (Smart Component)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SmartVariableInput (Interactive)
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ VariableSuggestionDropdown
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ParameterField (Adaptive)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ValidationMessage (Pure)
â”‚   â”‚   â”‚   â””â”€â”€ OutputConfiguration (Feature Component)
â”‚   â”‚   â””â”€â”€ AddStepButton (Action)
â”‚   â””â”€â”€ VariableBrowser (Context Display)
â””â”€â”€ ExecutionMonitor (Container)
    â”œâ”€â”€ VariableViewer (Data Display)
    â””â”€â”€ DataFlowVisualizer (Advanced Feature)
```

### æ ¸å¿ƒå‰ç«¯ç»„ä»¶è®¾è®¡

#### 1. SmartVariableInput ç»„ä»¶
**èŒè´£**: æä¾›IDEçº§åˆ«çš„å˜é‡å¼•ç”¨æ™ºèƒ½æç¤º

**æŠ€æœ¯è§„æ ¼**:
```typescript
interface SmartVariableInputProps {
  value: string;
  onChange: (value: string) => void;
  availableVariables: Variable[];
  placeholder?: string;
  disabled?: boolean;
  validationErrors?: string[];
}

interface Variable {
  name: string;
  type: DataType;
  sourceStep: number;
  description: string;
  preview?: any;
  lastUpdated?: Date;
}

enum DataType {
  STRING = 'string',
  NUMBER = 'number', 
  BOOLEAN = 'boolean',
  OBJECT = 'object',
  ARRAY = 'array'
}
```

**æ ¸å¿ƒåŠŸèƒ½å®ç°**:
- å®æ—¶è¯­æ³•æ£€æµ‹ï¼šæ­£åˆ™è¡¨è¾¾å¼ `/\$\{([^}]*)/g` æ£€æµ‹å˜é‡å¼•ç”¨
- æ™ºèƒ½è¿‡æ»¤ï¼šFuse.jsåº“å®ç°æ¨¡ç³Šæœç´¢
- é”®ç›˜å¯¼èˆªï¼šæ–¹å‘é”®é€‰æ‹©ï¼ŒEnterç¡®è®¤ï¼ŒESCå–æ¶ˆ
- å®æ—¶é¢„è§ˆï¼šæ˜¾ç¤ºå˜é‡å½“å‰å€¼å’Œç±»å‹ä¿¡æ¯

#### 2. StepParameterForm ç»„ä»¶
**èŒè´£**: æ ¹æ®Actionå®šä¹‰åŠ¨æ€ç”Ÿæˆå‚æ•°é…ç½®è¡¨å•

**åŠ¨æ€è¡¨å•ç”Ÿæˆç­–ç•¥**:
```typescript
interface ActionDefinition {
  id: string;
  displayName: string;
  icon: string;
  category: ActionCategory;
  requiredParams: string[];
  optionalParams: string[];
  paramTemplates: Record<string, ParameterTemplate>;
}

interface ParameterTemplate {
  type: ParameterType;
  placeholder: string;
  validation: ValidationRule[];
  supportVariables: boolean;
  defaultValue?: any;
  options?: SelectOption[];
}

enum ParameterType {
  STRING = 'string',
  NUMBER = 'number',
  BOOLEAN = 'boolean',
  SELECT = 'select',
  TEXTAREA = 'textarea',
  VARIABLE_NAME = 'variable_name',
  JSON_SCHEMA = 'json_schema'
}
```

#### 3. VariableSuggestionDropdown ç»„ä»¶
**èŒè´£**: æ˜¾ç¤ºå˜é‡æç¤ºåˆ—è¡¨ï¼Œæ”¯æŒé”®ç›˜å’Œé¼ æ ‡äº¤äº’

**UIè®¾è®¡è§„èŒƒ**:
- **å˜é‡åˆ†ç»„**: æŒ‰æ•°æ®ç±»å‹å’Œæ¥æºæ­¥éª¤åˆ†ç»„æ˜¾ç¤º
- **è§†è§‰å±‚æ¬¡**: ä½¿ç”¨é¢œè‰²ç¼–ç åŒºåˆ†ä¸åŒæ•°æ®ç±»å‹
- **ä¿¡æ¯å¯†åº¦**: æ˜¾ç¤ºå˜é‡åã€ç±»å‹ã€æ¥æºã€é¢„è§ˆå€¼
- **äº¤äº’åé¦ˆ**: æ‚¬åœé«˜äº®ã€é€‰ä¸­çŠ¶æ€ã€åŠ è½½çŠ¶æ€

### çŠ¶æ€ç®¡ç†æ¶æ„

#### Context API çŠ¶æ€åˆ†å±‚
```typescript
// å…¨å±€åº”ç”¨çŠ¶æ€
interface AppContextState {
  user: User;
  settings: AppSettings;
  theme: Theme;
}

// æµ‹è¯•ç”¨ä¾‹ç¼–è¾‘çŠ¶æ€
interface TestCaseEditorState {
  testCase: TestCase;
  steps: Step[];
  availableVariables: Variable[];
  validationErrors: Record<string, string[]>;
  isDirty: boolean;
}

// æ‰§è¡Œç›‘æ§çŠ¶æ€
interface ExecutionMonitorState {
  currentExecution: ExecutionHistory;
  executionContext: ExecutionContext;
  variableValues: Record<string, any>;
  stepStatus: StepExecutionStatus[];
}
```

#### çŠ¶æ€æ›´æ–°æ¨¡å¼
- **Reduceræ¨¡å¼**: å¤æ‚çŠ¶æ€å˜æ›´ä½¿ç”¨useReducerç®¡ç†
- **Optimistic UI**: ç”¨æˆ·æ“ä½œç«‹å³åæ˜ UIå˜åŒ–ï¼Œåå°åŒæ­¥
- **é”™è¯¯è¾¹ç•Œ**: ç»„ä»¶çº§é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æ˜¾ç¤º

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### æ¸²æŸ“ä¼˜åŒ–
- **React.memo**: çº¯ç»„ä»¶é¿å…ä¸å¿…è¦é‡æ¸²æŸ“
- **useMemo/useCallback**: æ˜‚è´µè®¡ç®—å’Œå‡½æ•°ç¼“å­˜
- **è™šæ‹ŸåŒ–åˆ—è¡¨**: å¤§é‡æ­¥éª¤åˆ—è¡¨ä½¿ç”¨react-window
- **ä»£ç åˆ†å‰²**: åŠ¨æ€å¯¼å…¥éæ ¸å¿ƒåŠŸèƒ½ç»„ä»¶

#### ç½‘ç»œä¼˜åŒ–
- **SWRç¼“å­˜**: å˜é‡æ•°æ®ä½¿ç”¨SWRå®ç°ç¼“å­˜å’Œé‡æ–°éªŒè¯
- **é˜²æŠ–å¤„ç†**: æ™ºèƒ½æç¤ºæœç´¢ä½¿ç”¨300msé˜²æŠ–
- **æ‰¹é‡è¯·æ±‚**: å¤šä¸ªå˜é‡æŸ¥è¯¢åˆå¹¶ä¸ºå•ä¸ªè¯·æ±‚

---

## âš™ï¸ åç«¯æ¶æ„è®¾è®¡

### æœåŠ¡æ¶æ„åˆ†å±‚
```
Presentation Layer (API Routes)
â”œâ”€â”€ /api/v1/testcases/          # æµ‹è¯•ç”¨ä¾‹CRUD
â”œâ”€â”€ /api/v1/variables/          # å˜é‡ç®¡ç†API  
â”œâ”€â”€ /api/v1/execution/          # æ‰§è¡Œæ§åˆ¶API
â”œâ”€â”€ /api/v1/validation/         # å‚æ•°éªŒè¯API
â””â”€â”€ /api/v1/suggestions/        # æ™ºèƒ½æç¤ºAPI

Business Logic Layer (Services)
â”œâ”€â”€ TestCaseService             # æµ‹è¯•ç”¨ä¾‹ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ VariableResolverService     # å˜é‡è§£ææœåŠ¡
â”œâ”€â”€ ExecutionContextService    # æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†
â”œâ”€â”€ ValidationService          # å‚æ•°éªŒè¯æœåŠ¡
â””â”€â”€ SuggestionService          # æ™ºèƒ½æç¤ºæœåŠ¡

Data Access Layer (Repositories)
â”œâ”€â”€ TestCaseRepository          # æµ‹è¯•ç”¨ä¾‹æ•°æ®è®¿é—®
â”œâ”€â”€ ExecutionHistoryRepository  # æ‰§è¡Œå†å²æ•°æ®è®¿é—®
â”œâ”€â”€ VariableRepository          # å˜é‡æ•°æ®è®¿é—®
â””â”€â”€ TemplateRepository          # æ¨¡æ¿æ•°æ®è®¿é—®
```

### æ ¸å¿ƒæœåŠ¡è®¾è®¡

#### 1. VariableResolverService
**èŒè´£**: è§£æå’Œæ›¿æ¢æ­¥éª¤å‚æ•°ä¸­çš„å˜é‡å¼•ç”¨

```python
class VariableResolverService:
    def __init__(self, execution_context: ExecutionContext):
        self.execution_context = execution_context
        self.variable_pattern = re.compile(r'\$\{([^}]+)\}')
    
    def resolve_step_parameters(self, step: Step) -> Step:
        """è§£ææ­¥éª¤å‚æ•°ä¸­çš„æ‰€æœ‰å˜é‡å¼•ç”¨"""
        resolved_params = {}
        
        for key, value in step.params.items():
            if isinstance(value, str):
                resolved_params[key] = self._resolve_string_value(value)
            else:
                resolved_params[key] = value
        
        return Step(
            action=step.action,
            params=resolved_params,
            description=step.description
        )
    
    def _resolve_string_value(self, text: str) -> str:
        """è§£æå­—ç¬¦ä¸²ä¸­çš„å˜é‡å¼•ç”¨"""
        def replace_variable(match):
            variable_path = match.group(1)
            return self._get_variable_value(variable_path)
        
        return self.variable_pattern.sub(replace_variable, text)
    
    def _get_variable_value(self, variable_path: str) -> str:
        """æ ¹æ®å˜é‡è·¯å¾„è·å–å˜é‡å€¼"""
        path_parts = variable_path.split('.')
        variable_name = path_parts[0]
        
        variable_data = self.execution_context.get_variable(variable_name)
        if not variable_data:
            raise VariableNotFoundError(f"Variable '{variable_name}' not found")
        
        # æ”¯æŒåµŒå¥—å±æ€§è®¿é—®
        current_value = variable_data.value
        for property_name in path_parts[1:]:
            if isinstance(current_value, dict) and property_name in current_value:
                current_value = current_value[property_name]
            else:
                raise VariablePropertyError(
                    f"Property '{property_name}' not found in variable '{variable_name}'"
                )
        
        return str(current_value)
```

#### 2. ExecutionContextService
**èŒè´£**: ç®¡ç†æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜é‡ä¸Šä¸‹æ–‡

```python
class ExecutionContextService:
    def __init__(self, execution_id: str):
        self.execution_id = execution_id
        self.variables: Dict[str, VariableData] = {}
        self.redis_client = get_redis_client()  # å¯é€‰çš„Redisç¼“å­˜
    
    def store_variable(self, 
                      variable_name: str, 
                      value: Any, 
                      data_type: DataType,
                      source_step: int) -> None:
        """å­˜å‚¨æ­¥éª¤è¾“å‡ºå˜é‡"""
        variable_data = VariableData(
            name=variable_name,
            value=value,
            data_type=data_type,
            source_step=source_step,
            created_at=datetime.utcnow()
        )
        
        # å†…å­˜å­˜å‚¨
        self.variables[variable_name] = variable_data
        
        # æ•°æ®åº“æŒä¹…åŒ–
        self._persist_variable(variable_data)
        
        # å¯é€‰çš„Redisç¼“å­˜
        if self.redis_client:
            self._cache_variable(variable_data)
    
    def get_variable(self, variable_name: str) -> Optional[VariableData]:
        """è·å–å˜é‡æ•°æ®"""
        # ä¼˜å…ˆä»å†…å­˜è·å–
        if variable_name in self.variables:
            return self.variables[variable_name]
        
        # ä»ç¼“å­˜è·å–
        if self.redis_client:
            cached_data = self._get_cached_variable(variable_name)
            if cached_data:
                return cached_data
        
        # ä»æ•°æ®åº“è·å–
        return self._load_variable_from_db(variable_name)
    
    def get_all_variables(self) -> List[VariableData]:
        """è·å–æ‰€æœ‰å¯ç”¨å˜é‡"""
        return list(self.variables.values())
    
    def validate_variable_references(self, text: str) -> List[ValidationError]:
        """éªŒè¯æ–‡æœ¬ä¸­çš„å˜é‡å¼•ç”¨æ˜¯å¦æœ‰æ•ˆ"""
        errors = []
        variable_pattern = re.compile(r'\$\{([^}]+)\}')
        
        for match in variable_pattern.finditer(text):
            variable_path = match.group(1)
            try:
                self._validate_variable_path(variable_path)
            except VariableError as e:
                errors.append(ValidationError(
                    message=str(e),
                    position=match.span(),
                    variable_path=variable_path
                ))
        
        return errors
```

#### 3. ValidationService
**èŒè´£**: å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

```python
class ValidationService:
    def __init__(self):
        self.action_definitions = load_action_definitions()
    
    def validate_step(self, step: Step, available_variables: List[str]) -> ValidationResult:
        """éªŒè¯æ­¥éª¤é…ç½®"""
        errors = []
        warnings = []
        
        # éªŒè¯Actionç±»å‹
        if step.action not in self.action_definitions:
            errors.append(f"Unknown action type: {step.action}")
            return ValidationResult(errors=errors, warnings=warnings)
        
        action_def = self.action_definitions[step.action]
        
        # éªŒè¯å¿…éœ€å‚æ•°
        for required_param in action_def.required_params:
            if required_param not in step.params:
                errors.append(f"Missing required parameter: {required_param}")
        
        # éªŒè¯å‚æ•°ç±»å‹å’Œæ ¼å¼
        for param_name, param_value in step.params.items():
            param_template = action_def.param_templates.get(param_name)
            if param_template:
                param_errors = self._validate_parameter(
                    param_name, param_value, param_template, available_variables
                )
                errors.extend(param_errors)
        
        return ValidationResult(errors=errors, warnings=warnings)
    
    def _validate_parameter(self, 
                           param_name: str,
                           param_value: Any,
                           param_template: ParameterTemplate,
                           available_variables: List[str]) -> List[str]:
        """éªŒè¯å•ä¸ªå‚æ•°"""
        errors = []
        
        # ç±»å‹éªŒè¯
        if param_template.type == ParameterType.STRING:
            if not isinstance(param_value, str):
                errors.append(f"Parameter '{param_name}' must be a string")
        
        # å˜é‡å¼•ç”¨éªŒè¯
        if param_template.support_variables and isinstance(param_value, str):
            variable_errors = self._validate_variable_references(
                param_value, available_variables
            )
            errors.extend(variable_errors)
        
        # è‡ªå®šä¹‰éªŒè¯è§„åˆ™
        for validation_rule in param_template.validation_rules:
            rule_errors = self._apply_validation_rule(param_value, validation_rule)
            errors.extend(rule_errors)
        
        return errors
```

### APIè®¾è®¡è§„èŒƒ

#### RESTful APIç»“æ„
```python
# å˜é‡ç®¡ç†API
GET    /api/v1/executions/{execution_id}/variables
POST   /api/v1/executions/{execution_id}/variables
GET    /api/v1/executions/{execution_id}/variables/{variable_name}
PUT    /api/v1/executions/{execution_id}/variables/{variable_name}
DELETE /api/v1/executions/{execution_id}/variables/{variable_name}

# æ™ºèƒ½æç¤ºAPI
GET    /api/v1/testcases/{testcase_id}/variable-suggestions
POST   /api/v1/variables/search

# å‚æ•°éªŒè¯API
POST   /api/v1/steps/validate
POST   /api/v1/testcases/{testcase_id}/validate

# æ‰§è¡Œæ§åˆ¶API
POST   /api/v1/testcases/{testcase_id}/execute
GET    /api/v1/executions/{execution_id}/status
POST   /api/v1/executions/{execution_id}/stop
```

#### APIå“åº”æ ‡å‡†æ ¼å¼
```json
{
  "success": true,
  "data": {
    // å…·ä½“æ•°æ®å†…å®¹
  },
  "meta": {
    "timestamp": "2025-01-30T10:00:00Z",
    "request_id": "req_123456",
    "execution_time": "150ms"
  },
  "errors": [],
  "warnings": []
}
```

---

## ğŸ¤– AIå¼•æ“æ¶æ„å¢å¼º

### MidSceneJSé›†æˆæ¶æ„
```
MidSceneJS Server (Node.js)
â”œâ”€â”€ Express HTTP API
â”‚   â”œâ”€â”€ /api/extract-data          # æ•°æ®æå–æ¥å£
â”‚   â”œâ”€â”€ /api/extract-string        # å­—ç¬¦ä¸²æå–
â”‚   â”œâ”€â”€ /api/extract-number        # æ•°å­—æå–
â”‚   â”œâ”€â”€ /api/extract-object        # å¯¹è±¡æå–
â”‚   â””â”€â”€ /api/extract-array         # æ•°ç»„æå–
â”œâ”€â”€ Playwright Browser Manager
â”‚   â”œâ”€â”€ Browser Pool Management    # æµè§ˆå™¨æ± ç®¡ç†
â”‚   â”œâ”€â”€ Page Context Isolation     # é¡µé¢ä¸Šä¸‹æ–‡éš”ç¦»
â”‚   â””â”€â”€ Resource Optimization      # èµ„æºä¼˜åŒ–
â””â”€â”€ AI Model Integration
    â”œâ”€â”€ OpenAI/Qwen-VL Integration # AIæ¨¡å‹é›†æˆ
    â”œâ”€â”€ Token Usage Optimization   # Tokenä½¿ç”¨ä¼˜åŒ–
    â””â”€â”€ Response Caching          # å“åº”ç¼“å­˜
```

### ç°æœ‰APIè¿”å›å€¼æ•è·è®¾è®¡

#### è¿”å›å€¼æ•è·æ¥å£å¢å¼º
```javascript
// å¢å¼ºç°æœ‰çš„Midscene APIæ‰§è¡Œï¼Œæ”¯æŒè¿”å›å€¼æ•è·
app.post('/api/execute-step', async (req, res) => {
    const { 
        action,          // ç°æœ‰çš„Midscene APIæ–¹æ³•å (aiQuery, aiStringç­‰)
        params,          // åŸæœ‰çš„APIå‚æ•°
        outputVariable,  // å¯é€‰ï¼šè¾“å‡ºå˜é‡å
        executionId      // æ‰§è¡Œä¸Šä¸‹æ–‡ID
    } = req.body;
    
    try {
        // è·å–å½“å‰é¡µé¢å®ä¾‹
        const page = await getCurrentPage(req.headers['execution-id']);
        
        // åŠ¨æ€è°ƒç”¨å¯¹åº”çš„Midscene APIæ–¹æ³•
        let result;
        switch(action) {
            case 'aiQuery':
                result = await page.aiQuery(params.query, params.dataDemand, params.options);
                break;
            case 'aiString':
                result = await page.aiString(params.query, params.options);
                break;
            case 'aiNumber':
                result = await page.aiNumber(params.query, params.options);
                break;
            case 'aiBoolean':
                result = await page.aiBoolean(params.query, params.options);
                break;
            case 'aiAsk':
                result = await page.aiAsk(params.question, params.options);
                break;
            case 'aiLocate':
                result = await page.aiLocate(params.prompt, params.options);
                break;
            case 'evaluateJavaScript':
                result = await page.evaluateJavaScript(params.script);
                break;
            default:
                // å¯¹äºæ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼Œæ­£å¸¸æ‰§è¡Œä½†ä¸æ•è·è¿”å›å€¼
                result = await page[action](params);
        }
        
        // å¦‚æœæŒ‡å®šäº†è¾“å‡ºå˜é‡åï¼Œåˆ™å­˜å‚¨è¿”å›å€¼
        if (outputVariable && result !== undefined) {
            await storeVariableData({
                executionId: executionId,
                variableName: outputVariable,
                value: result,
                dataType: typeof result,
                apiMethod: action,
                apiParams: params,
                timestamp: new Date()
            });
        }
        
        res.json({
            success: true,
            data: {
                result: result,
                variable: outputVariable,
                dataType: typeof result,
                executionTime: Date.now() - startTime
            }
        });
        
    } catch (error) {
        logger.error('API execution failed', { 
            error: error.message,
            action,
            params,
            executionId: executionId
        });
        
        res.status(500).json({
            success: false,
            error: {
                message: error.message,
                type: 'EXTRACTION_ERROR',
                query: query,
                suggestions: generateErrorSuggestions(error)
            }
        });
    }
});
```

#### ä¸“ç”¨æ•°æ®æå–æ¥å£
```javascript
// å­—ç¬¦ä¸²æå–
app.post('/api/extract-string', async (req, res) => {
    const { query, outputVariable } = req.body;
    const result = await page.aiString(query);
    // ... å¤„ç†é€»è¾‘
});

// æ•°å­—æå–  
app.post('/api/extract-number', async (req, res) => {
    const { query, outputVariable } = req.body;
    const result = await page.aiNumber(query);
    // ... å¤„ç†é€»è¾‘
});

// å¸ƒå°”å€¼æå–
app.post('/api/extract-boolean', async (req, res) => {
    const { query, outputVariable } = req.body;
    const result = await page.aiBoolean(query);
    // ... å¤„ç†é€»è¾‘
});
```

### AIæ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. è¯·æ±‚ç¼“å­˜æœºåˆ¶
```javascript
class AIRequestCache {
    constructor() {
        this.cache = new Map();
        this.ttl = 5 * 60 * 1000; // 5åˆ†é’ŸTTL
    }
    
    generateCacheKey(query, schema, pageHash) {
        return crypto.createHash('md5')
            .update(`${query}:${schema}:${pageHash}`)
            .digest('hex');
    }
    
    async get(cacheKey) {
        const cached = this.cache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < this.ttl) {
            return cached.data;
        }
        return null;
    }
    
    set(cacheKey, data) {
        this.cache.set(cacheKey, {
            data: data,
            timestamp: Date.now()
        });
    }
}
```

#### 2. æµè§ˆå™¨èµ„æºæ± ç®¡ç†
```javascript
class BrowserPoolManager {
    constructor() {
        this.browserPool = [];
        this.maxPoolSize = 5;
        this.currentPool = 0;
    }
    
    async getBrowser() {
        if (this.currentPool < this.maxPoolSize) {
            const browser = await chromium.launch({
                headless: true,
                args: [
                    '--no-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-background-timer-throttling',
                    '--disable-backgrounding-occluded-windows',
                    '--disable-renderer-backgrounding'
                ]
            });
            this.browserPool.push(browser);
            this.currentPool++;
            return browser;
        }
        
        // å¤ç”¨ç°æœ‰æµè§ˆå™¨å®ä¾‹
        return this.browserPool[Math.floor(Math.random() * this.browserPool.length)];
    }
    
    async cleanup() {
        for (const browser of this.browserPool) {
            await browser.close();
        }
        this.browserPool = [];
        this.currentPool = 0;
    }
}
```

---

## ğŸ—„ï¸ æ•°æ®æ¶æ„è®¾è®¡

### æ•°æ®æ¨¡å‹æ‰©å±•

#### æ ¸å¿ƒè¡¨ç»“æ„å˜æ›´
```sql
-- 1. æ‰©å±•StepExecutionè¡¨æ”¯æŒè¾“å‡ºæ•°æ®
ALTER TABLE step_executions 
ADD COLUMN output_data TEXT COMMENT 'æ­¥éª¤è¾“å‡ºæ•°æ®(JSONæ ¼å¼)',
ADD COLUMN output_variable VARCHAR(255) COMMENT 'è¾“å‡ºå˜é‡å',
ADD COLUMN output_type VARCHAR(50) COMMENT 'è¾“å‡ºæ•°æ®ç±»å‹',
ADD COLUMN extraction_query TEXT COMMENT 'æ•°æ®æå–æŸ¥è¯¢',
ADD COLUMN extraction_schema TEXT COMMENT 'æ•°æ®æå–Schema',
ADD INDEX idx_output_variable (output_variable),
ADD INDEX idx_execution_variable (execution_id, output_variable);

-- 2. æ–°å¢ExecutionContextè¡¨ç®¡ç†å˜é‡ä¸Šä¸‹æ–‡
CREATE TABLE execution_contexts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    execution_id VARCHAR(50) NOT NULL COMMENT 'æ‰§è¡ŒID',
    variable_name VARCHAR(255) NOT NULL COMMENT 'å˜é‡å',
    variable_value TEXT NOT NULL COMMENT 'å˜é‡å€¼(JSONæ ¼å¼)',
    variable_type ENUM('string', 'number', 'boolean', 'object', 'array') NOT NULL,
    source_step_index INT NOT NULL COMMENT 'æ¥æºæ­¥éª¤ç´¢å¼•',
    extraction_query TEXT COMMENT 'æ•°æ®æå–æŸ¥è¯¢',
    extraction_schema TEXT COMMENT 'æ•°æ®æå–Schema',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES execution_history(execution_id) ON DELETE CASCADE,
    UNIQUE KEY uk_execution_variable (execution_id, variable_name),
    INDEX idx_execution_id (execution_id),
    INDEX idx_variable_name (variable_name),
    INDEX idx_variable_type (variable_type),
    INDEX idx_source_step (source_step_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ‰§è¡Œä¸Šä¸‹æ–‡å˜é‡è¡¨';

-- 3. æ–°å¢ActionDefinitionsè¡¨ç®¡ç†Actionå…ƒæ•°æ®  
CREATE TABLE action_definitions (
    id VARCHAR(100) PRIMARY KEY COMMENT 'Action ID',
    display_name VARCHAR(255) NOT NULL COMMENT 'æ˜¾ç¤ºåç§°',
    icon VARCHAR(50) COMMENT 'å›¾æ ‡',
    category ENUM('navigation', 'interaction', 'assertion', 'data', 'control') NOT NULL,
    description TEXT COMMENT 'æè¿°',
    required_params JSON NOT NULL COMMENT 'å¿…éœ€å‚æ•°åˆ—è¡¨',
    optional_params JSON COMMENT 'å¯é€‰å‚æ•°åˆ—è¡¨',
    param_templates JSON NOT NULL COMMENT 'å‚æ•°æ¨¡æ¿å®šä¹‰',
    version VARCHAR(20) DEFAULT '1.0.0',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_category (category),
    INDEX idx_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Actionå®šä¹‰è¡¨';

-- 4. æ–°å¢VariableSchemasè¡¨ç®¡ç†æ•°æ®Schema
CREATE TABLE variable_schemas (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    schema_name VARCHAR(255) NOT NULL COMMENT 'Schemaåç§°',
    schema_definition JSON NOT NULL COMMENT 'Schemaå®šä¹‰',
    description TEXT COMMENT 'æè¿°',
    usage_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    created_by VARCHAR(100) COMMENT 'åˆ›å»ºè€…',
    is_public BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å…¬å¼€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_schema_name (schema_name),
    INDEX idx_public (is_public),
    INDEX idx_usage (usage_count DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å˜é‡Schemaå®šä¹‰è¡¨';
```

#### æ•°æ®æ¨¡å‹ç±»è®¾è®¡
```python
from sqlalchemy import Column, Integer, String, Text, DateTime, Boolean, Enum, JSON
from sqlalchemy.ext.declarative import declarative_base
from datetime import datetime
import json

Base = declarative_base()

class ExecutionContext(Base):
    """æ‰§è¡Œä¸Šä¸‹æ–‡å˜é‡æ¨¡å‹"""
    __tablename__ = 'execution_contexts'
    
    id = Column(Integer, primary_key=True)
    execution_id = Column(String(50), nullable=False)
    variable_name = Column(String(255), nullable=False)
    variable_value = Column(Text, nullable=False)
    variable_type = Column(Enum('string', 'number', 'boolean', 'object', 'array'), nullable=False)
    source_step_index = Column(Integer, nullable=False)
    extraction_query = Column(Text)
    extraction_schema = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'execution_id': self.execution_id,
            'variable_name': self.variable_name,
            'variable_value': json.loads(self.variable_value),
            'variable_type': self.variable_type,
            'source_step_index': self.source_step_index,
            'extraction_query': self.extraction_query,
            'extraction_schema': self.extraction_schema,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    @classmethod
    def from_dict(cls, data):
        return cls(
            execution_id=data['execution_id'],
            variable_name=data['variable_name'],
            variable_value=json.dumps(data['variable_value']),
            variable_type=data['variable_type'],
            source_step_index=data['source_step_index'],
            extraction_query=data.get('extraction_query'),
            extraction_schema=data.get('extraction_schema')
        )

class ActionDefinition(Base):
    """Actionå®šä¹‰æ¨¡å‹"""
    __tablename__ = 'action_definitions'
    
    id = Column(String(100), primary_key=True)
    display_name = Column(String(255), nullable=False)
    icon = Column(String(50))
    category = Column(Enum('navigation', 'interaction', 'assertion', 'data', 'control'), nullable=False)
    description = Column(Text)
    required_params = Column(JSON, nullable=False)
    optional_params = Column(JSON)
    param_templates = Column(JSON, nullable=False)
    version = Column(String(20), default='1.0.0')
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'display_name': self.display_name,
            'icon': self.icon,
            'category': self.category,
            'description': self.description,
            'required_params': self.required_params,
            'optional_params': self.optional_params,
            'param_templates': self.param_templates,
            'version': self.version,
            'is_active': self.is_active
        }

class VariableSchema(Base):
    """å˜é‡Schemaå®šä¹‰æ¨¡å‹"""
    __tablename__ = 'variable_schemas'
    
    id = Column(Integer, primary_key=True)
    schema_name = Column(String(255), nullable=False, unique=True)
    schema_definition = Column(JSON, nullable=False)
    description = Column(Text)
    usage_count = Column(Integer, default=0)
    created_by = Column(String(100))
    is_public = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'schema_name': self.schema_name,
            'schema_definition': self.schema_definition,
            'description': self.description,
            'usage_count': self.usage_count,
            'created_by': self.created_by,
            'is_public': self.is_public,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
```

### æ•°æ®è®¿é—®å±‚è®¾è®¡

#### Repositoryæ¨¡å¼å®ç°
```python
class ExecutionContextRepository:
    """æ‰§è¡Œä¸Šä¸‹æ–‡æ•°æ®è®¿é—®å±‚"""
    
    def __init__(self, db_session):
        self.db = db_session
    
    def create_variable(self, variable_data: dict) -> ExecutionContext:
        """åˆ›å»ºå˜é‡è®°å½•"""
        context = ExecutionContext.from_dict(variable_data)
        self.db.add(context)
        self.db.commit()
        return context
    
    def get_variable(self, execution_id: str, variable_name: str) -> Optional[ExecutionContext]:
        """è·å–æŒ‡å®šå˜é‡"""
        return self.db.query(ExecutionContext).filter(
            ExecutionContext.execution_id == execution_id,
            ExecutionContext.variable_name == variable_name
        ).first()
    
    def get_all_variables(self, execution_id: str) -> List[ExecutionContext]:
        """è·å–æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„æ‰€æœ‰å˜é‡"""
        return self.db.query(ExecutionContext).filter(
            ExecutionContext.execution_id == execution_id
        ).order_by(ExecutionContext.source_step_index).all()
    
    def update_variable(self, execution_id: str, variable_name: str, new_value: any) -> bool:
        """æ›´æ–°å˜é‡å€¼"""
        context = self.get_variable(execution_id, variable_name)
        if context:
            context.variable_value = json.dumps(new_value)
            context.updated_at = datetime.utcnow()
            self.db.commit()
            return True
        return False
    
    def delete_variable(self, execution_id: str, variable_name: str) -> bool:
        """åˆ é™¤å˜é‡"""
        deleted_count = self.db.query(ExecutionContext).filter(
            ExecutionContext.execution_id == execution_id,
            ExecutionContext.variable_name == variable_name
        ).delete()
        self.db.commit()
        return deleted_count > 0
    
    def cleanup_execution_context(self, execution_id: str) -> int:
        """æ¸…ç†æ‰§è¡Œä¸Šä¸‹æ–‡(æ‰§è¡Œå®Œæˆåè°ƒç”¨)"""
        deleted_count = self.db.query(ExecutionContext).filter(
            ExecutionContext.execution_id == execution_id
        ).delete()
        self.db.commit()
        return deleted_count
```

### æ•°æ®è¿ç§»ç­–ç•¥

#### æ•°æ®åº“è¿ç§»è„šæœ¬
```python
"""
æ•°æ®æµåŠŸèƒ½æ•°æ®åº“è¿ç§»è„šæœ¬
Migration: add_dataflow_support
"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

def upgrade():
    # 1. æ‰©å±•step_executionsè¡¨
    op.add_column('step_executions', 
        sa.Column('output_data', sa.Text(), nullable=True, comment='æ­¥éª¤è¾“å‡ºæ•°æ®'))
    op.add_column('step_executions', 
        sa.Column('output_variable', sa.String(255), nullable=True, comment='è¾“å‡ºå˜é‡å'))
    op.add_column('step_executions', 
        sa.Column('output_type', sa.String(50), nullable=True, comment='è¾“å‡ºæ•°æ®ç±»å‹'))
    op.add_column('step_executions', 
        sa.Column('extraction_query', sa.Text(), nullable=True, comment='æ•°æ®æå–æŸ¥è¯¢'))
    op.add_column('step_executions', 
        sa.Column('extraction_schema', sa.Text(), nullable=True, comment='æ•°æ®æå–Schema'))
    
    # æ·»åŠ ç´¢å¼•
    op.create_index('idx_output_variable', 'step_executions', ['output_variable'])
    op.create_index('idx_execution_variable', 'step_executions', ['execution_id', 'output_variable'])
    
    # 2. åˆ›å»ºexecution_contextsè¡¨
    op.create_table('execution_contexts',
        sa.Column('id', sa.BigInteger(), nullable=False),
        sa.Column('execution_id', sa.String(50), nullable=False),
        sa.Column('variable_name', sa.String(255), nullable=False),
        sa.Column('variable_value', sa.Text(), nullable=False),
        sa.Column('variable_type', sa.Enum('string', 'number', 'boolean', 'object', 'array'), nullable=False),
        sa.Column('source_step_index', sa.Integer(), nullable=False),
        sa.Column('extraction_query', sa.Text(), nullable=True),
        sa.Column('extraction_schema', sa.Text(), nullable=True),
        sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP')),
        sa.ForeignKeyConstraint(['execution_id'], ['execution_history.execution_id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('execution_id', 'variable_name', name='uk_execution_variable'),
        mysql_engine='InnoDB',
        mysql_charset='utf8mb4',
        mysql_comment='æ‰§è¡Œä¸Šä¸‹æ–‡å˜é‡è¡¨'
    )
    
    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_execution_id', 'execution_contexts', ['execution_id'])
    op.create_index('idx_variable_name', 'execution_contexts', ['variable_name'])
    op.create_index('idx_variable_type', 'execution_contexts', ['variable_type'])
    op.create_index('idx_source_step', 'execution_contexts', ['source_step_index'])

    # 3. åˆ›å»ºaction_definitionsè¡¨
    op.create_table('action_definitions',
        sa.Column('id', sa.String(100), nullable=False),
        sa.Column('display_name', sa.String(255), nullable=False),
        sa.Column('icon', sa.String(50), nullable=True),
        sa.Column('category', sa.Enum('navigation', 'interaction', 'assertion', 'data', 'control'), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('required_params', sa.JSON(), nullable=False),
        sa.Column('optional_params', sa.JSON(), nullable=True),
        sa.Column('param_templates', sa.JSON(), nullable=False),
        sa.Column('version', sa.String(20), server_default='1.0.0'),
        sa.Column('is_active', sa.Boolean(), server_default='1'),
        sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP')),
        sa.PrimaryKeyConstraint('id'),
        mysql_engine='InnoDB',
        mysql_charset='utf8mb4',
        mysql_comment='Actionå®šä¹‰è¡¨'
    )
    
    op.create_index('idx_category', 'action_definitions', ['category'])
    op.create_index('idx_active', 'action_definitions', ['is_active'])

    # 4. æ’å…¥é»˜è®¤Actionå®šä¹‰æ•°æ®
    insert_default_action_definitions()

def downgrade():
    # åˆ é™¤æ–°å¢çš„è¡¨
    op.drop_table('execution_contexts')
    op.drop_table('action_definitions')
    
    # åˆ é™¤step_executionsè¡¨çš„æ–°å¢åˆ—
    op.drop_index('idx_execution_variable', 'step_executions')
    op.drop_index('idx_output_variable', 'step_executions')
    op.drop_column('step_executions', 'extraction_schema')
    op.drop_column('step_executions', 'extraction_query')
    op.drop_column('step_executions', 'output_type')
    op.drop_column('step_executions', 'output_variable')
    op.drop_column('step_executions', 'output_data')

def insert_default_action_definitions():
    """æ’å…¥é»˜è®¤çš„Actionå®šä¹‰æ•°æ®"""
    from sqlalchemy import text
    
    default_actions = [
        {
            'id': 'ai_extract_string',
            'display_name': 'æå–å­—ç¬¦ä¸²',
            'icon': 'ğŸ“',
            'category': 'data',
            'description': 'ä»é¡µé¢ä¸­æå–å­—ç¬¦ä¸²æ•°æ®',
            'required_params': ['query', 'output_variable'],
            'optional_params': ['timeout'],
            'param_templates': {
                'query': {
                    'type': 'string',
                    'placeholder': 'æè¿°è¦æå–çš„å­—ç¬¦ä¸²æ•°æ®',
                    'support_variables': False,
                    'validation': ['required']
                },
                'output_variable': {
                    'type': 'variable_name',
                    'placeholder': 'å˜é‡åï¼ˆå¦‚ï¼šproduct_nameï¼‰',
                    'pattern': '^[a-zA-Z_][a-zA-Z0-9_]*$',
                    'validation': ['required', 'variable_name']
                },
                'timeout': {
                    'type': 'number',
                    'default': 10000,
                    'min': 1000,
                    'max': 60000,
                    'unit': 'æ¯«ç§’'
                }
            }
        },
        # ... æ›´å¤šé»˜è®¤Actionå®šä¹‰
    ]
    
    # æ‰§è¡Œæ’å…¥æ“ä½œ
    # ... å®ç°æ•°æ®æ’å…¥é€»è¾‘
```

---

## ğŸ—ï¸ åŸºç¡€è®¾æ–½æ¶æ„

### äº‘æœåŠ¡æ¶æ„
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cloudflare    â”‚
                    â”‚   CDN + WAF     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Vercel      â”‚
                    â”‚  Frontend Host  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   Supabase   â”‚ â”‚   Node.js    â”‚ â”‚    Redis     â”‚
    â”‚  PostgreSQL  â”‚ â”‚ MidSceneJS   â”‚ â”‚    Cache     â”‚
    â”‚   Database   â”‚ â”‚   Server     â”‚ â”‚   (Optional) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²æ¶æ„è®¾è®¡

#### 1. Vercelæ— æœåŠ¡å™¨éƒ¨ç½²
```javascript
// vercel.jsoné…ç½®
{
  "version": 2,
  "builds": [
    {
      "src": "api/index.py",
      "use": "@vercel/python"
    },
    {
      "src": "web_gui/static/**",
      "use": "@vercel/static"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/index.py"
    },
    {
      "src": "/static/(.*)",
      "dest": "/web_gui/static/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/api/index.py"
    }
  ],
  "env": {
    "DATABASE_URL": "@database_url",
    "OPENAI_API_KEY": "@openai_api_key",
    "REDIS_URL": "@redis_url"
  },
  "functions": {
    "api/index.py": {
      "memory": 1024,
      "maxDuration": 30
    }
  }
}
```

#### 2. æœ¬åœ°ä»£ç†åŒ…æ¶æ„
```
Local Proxy Package
â”œâ”€â”€ midscene_server.js          # MidSceneJSæœåŠ¡å™¨
â”œâ”€â”€ package.json                # ä¾èµ–å®šä¹‰
â”œâ”€â”€ start.sh / start.bat        # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ default.json           # é»˜è®¤é…ç½®
â”‚   â””â”€â”€ production.json        # ç”Ÿäº§é…ç½®
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ browser-manager.js     # æµè§ˆå™¨ç®¡ç†
â”‚   â”œâ”€â”€ cache-manager.js       # ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ performance-monitor.js # æ€§èƒ½ç›‘æ§
â””â”€â”€ logs/                      # æ—¥å¿—ç›®å½•
```

#### 3. æ•°æ®åº“æ¶æ„ä¼˜åŒ–
```sql
-- åˆ†åº“åˆ†è¡¨ç­–ç•¥
-- 1. æŒ‰æ‰§è¡ŒID hashåˆ†è¡¨execution_contexts
CREATE TABLE execution_contexts_0 LIKE execution_contexts;
CREATE TABLE execution_contexts_1 LIKE execution_contexts;
-- ... æ›´å¤šåˆ†è¡¨

-- 2. æ•°æ®å½’æ¡£ç­–ç•¥
-- æ‰§è¡Œå†å²æ•°æ®æŒ‰æœˆå½’æ¡£
CREATE TABLE execution_history_archive_202501 LIKE execution_history;

-- 3. è¯»å†™åˆ†ç¦»é…ç½®
-- ä¸»åº“ï¼šå†™æ“ä½œ
-- ä»åº“ï¼šè¯»æ“ä½œå’ŒæŠ¥è¡¨æŸ¥è¯¢
```

### ç›‘æ§å’Œå¯è§‚æµ‹æ€§

#### 1. åº”ç”¨æ€§èƒ½ç›‘æ§(APM)
```python
# Sentryé”™è¯¯ç›‘æ§é›†æˆ
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration
from sentry_sdk.integrations.sqlalchemy import SqlalchemyIntegration

sentry_sdk.init(
    dsn="YOUR_SENTRY_DSN",
    integrations=[
        FlaskIntegration(transaction_style='endpoint'),
        SqlalchemyIntegration(),
    ],
    traces_sample_rate=0.1,
    environment=os.getenv('ENVIRONMENT', 'development')
)

# è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡
from prometheus_client import Counter, Histogram, Gauge

# å˜é‡è§£ææ€§èƒ½æŒ‡æ ‡
variable_resolution_duration = Histogram(
    'variable_resolution_duration_seconds',
    'Time spent resolving variables',
    ['execution_id', 'variable_count']
)

# æ•°æ®æå–æ€§èƒ½æŒ‡æ ‡
data_extraction_duration = Histogram(
    'data_extraction_duration_seconds', 
    'Time spent extracting data',
    ['action_type', 'success']
)

# æ™ºèƒ½æç¤ºè¯·æ±‚è®¡æ•°
suggestion_requests_total = Counter(
    'suggestion_requests_total',
    'Total suggestion requests',
    ['request_type', 'status']
)
```

#### 2. æ—¥å¿—æ¶æ„è®¾è®¡
```python
import structlog
import logging
from pythonjsonlogger import jsonlogger

# ç»“æ„åŒ–æ—¥å¿—é…ç½®
def configure_logging():
    # JSONæ ¼å¼æ—¥å¿—è¾“å‡º
    json_handler = logging.StreamHandler()
    formatter = jsonlogger.JsonFormatter(
        '%(asctime)s %(name)s %(levelname)s %(message)s'
    )
    json_handler.setFormatter(formatter)
    
    # é…ç½®ä¸åŒçº§åˆ«çš„logger
    loggers = {
        'dataflow': logging.getLogger('dataflow'),
        'variable_resolution': logging.getLogger('variable_resolution'),
        'ai_extraction': logging.getLogger('ai_extraction'),
        'performance': logging.getLogger('performance')
    }
    
    for logger in loggers.values():
        logger.addHandler(json_handler)
        logger.setLevel(logging.INFO)
    
    return loggers

# ä½¿ç”¨ç¤ºä¾‹
logger = configure_logging()['dataflow']
logger.info("Variable resolved", 
    extra={
        'execution_id': execution_id,
        'variable_name': variable_name,
        'resolution_time_ms': resolution_time,
        'variable_type': variable_type
    }
)
```

### å®‰å…¨æ¶æ„

#### 1. æ•°æ®å®‰å…¨ç­–ç•¥
```python
from cryptography.fernet import Fernet
import os

class VariableDataEncryption:
    """å˜é‡æ•°æ®åŠ å¯†ç®¡ç†"""
    
    def __init__(self):
        # ä»ç¯å¢ƒå˜é‡è·å–åŠ å¯†å¯†é’¥
        self.encryption_key = os.getenv('VARIABLE_ENCRYPTION_KEY')
        if not self.encryption_key:
            self.encryption_key = Fernet.generate_key()
        self.cipher_suite = Fernet(self.encryption_key)
    
    def encrypt_variable_data(self, data: dict) -> str:
        """åŠ å¯†å˜é‡æ•°æ®"""
        json_data = json.dumps(data, ensure_ascii=False)
        encrypted_data = self.cipher_suite.encrypt(json_data.encode())
        return encrypted_data.decode()
    
    def decrypt_variable_data(self, encrypted_data: str) -> dict:
        """è§£å¯†å˜é‡æ•°æ®"""
        decrypted_data = self.cipher_suite.decrypt(encrypted_data.encode())
        return json.loads(decrypted_data.decode())
```

#### 2. APIå®‰å…¨é˜²æŠ¤
```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from functools import wraps
import jwt

# APIé™æµé…ç½®
limiter = Limiter(
    app,
    key_func=get_remote_address,
    default_limits=["1000 per hour"]
)

# JWTè®¤è¯è£…é¥°å™¨
def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'error': 'No token provided'}), 401
        
        try:
            payload = jwt.decode(token, app.config['SECRET_KEY'], algorithms=['HS256'])
            request.user_id = payload['user_id']
        except jwt.InvalidTokenError:
            return jsonify({'error': 'Invalid token'}), 401
        
        return f(*args, **kwargs)
    return decorated_function

# æ•°æ®è®¿é—®æƒé™æ§åˆ¶
@app.route('/api/v1/executions/<execution_id>/variables')
@require_auth
@limiter.limit("100 per minute")
def get_execution_variables(execution_id):
    # éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æ‰§è¡Œçš„å˜é‡æ•°æ®
    if not has_execution_access(request.user_id, execution_id):
        return jsonify({'error': 'Access denied'}), 403
    
    # ... ä¸šåŠ¡é€»è¾‘
```

---

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´æ¶æ„

### CI/CDæµæ°´çº¿è®¾è®¡
```yaml
# .github/workflows/deploy.yml
name: Deploy Intent Test Framework

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install -r web_gui/requirements.txt
    
    - name: Install Node.js dependencies
      run: npm install
    
    - name: Run Python tests
      run: |
        python -m pytest tests/ -v --cov=web_gui --cov-report=xml
    
    - name: Run Node.js tests
      run: npm test
    
    - name: Run integration tests
      run: |
        python -m pytest tests/integration/ -v
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3

  build-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build frontend
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: web_gui/static/dist/

  deploy-vercel:
    needs: [test, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: web_gui/static/dist/
    
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'

  generate-proxy-package:
    needs: [test, build-frontend]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Package local proxy
      run: |
        mkdir -p proxy-package
        cp midscene_server.js proxy-package/
        cp package.json proxy-package/
        cp -r config/ proxy-package/
        cp -r lib/ proxy-package/
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > proxy-package/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting Intent Test Framework Local Proxy..."
        npm install
        node midscene_server.js
        EOF
        chmod +x proxy-package/start.sh
        
        # æ‰“åŒ…
        tar -czf intent-test-proxy-v${{ github.run_number }}.tar.gz proxy-package/
    
    - name: Upload proxy package
      uses: actions/upload-artifact@v3
      with:
        name: proxy-package
        path: intent-test-proxy-v${{ github.run_number }}.tar.gz
```

### æ•°æ®åº“è¿ç§»ç®¡ç†
```python
# migrations/ç®¡ç†è„šæœ¬
import alembic.config
import os

class DatabaseMigrationManager:
    def __init__(self, database_url):
        self.database_url = database_url
        self.alembic_cfg = alembic.config.Config("alembic.ini")
        self.alembic_cfg.set_main_option("sqlalchemy.url", database_url)
    
    def migrate_to_latest(self):
        """è¿ç§»åˆ°æœ€æ–°ç‰ˆæœ¬"""
        from alembic import command
        command.upgrade(self.alembic_cfg, "head")
    
    def create_migration(self, message):
        """åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬"""
        from alembic import command
        command.revision(self.alembic_cfg, message=message, autogenerate=True)
    
    def rollback_migration(self, revision="-1"):
        """å›æ»šè¿ç§»"""
        from alembic import command
        command.downgrade(self.alembic_cfg, revision)
    
    def get_current_revision(self):
        """è·å–å½“å‰æ•°æ®åº“ç‰ˆæœ¬"""
        from alembic import command
        return command.current(self.alembic_cfg)

# éƒ¨ç½²æ—¶çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
def initialize_database():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    migration_manager = DatabaseMigrationManager(os.getenv('DATABASE_URL'))
    
    try:
        # æ‰§è¡Œè¿ç§»
        migration_manager.migrate_to_latest()
        
        # åˆå§‹åŒ–åŸºç¡€æ•°æ®
        initialize_action_definitions()
        initialize_default_schemas()
        
        print("Database initialized successfully")
        
    except Exception as e:
        print(f"Database initialization failed: {e}")
        raise
```

### æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦
```python
# monitoring/performance_monitor.py
import time
from functools import wraps
from prometheus_client import start_http_server, Summary, Counter, Histogram

# æ€§èƒ½æŒ‡æ ‡å®šä¹‰
REQUEST_TIME = Summary('request_processing_seconds', 'Time spent processing request')
REQUEST_COUNT = Counter('requests_total', 'Total requests', ['method', 'endpoint', 'status'])
VARIABLE_RESOLUTION_TIME = Histogram('variable_resolution_seconds', 'Variable resolution time')
DATA_EXTRACTION_TIME = Histogram('data_extraction_seconds', 'Data extraction time')

def monitor_performance(metric_name=None):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            start_time = time.time()
            
            try:
                result = f(*args, **kwargs)
                status = 'success'
                return result
            except Exception as e:
                status = 'error'
                raise
            finally:
                duration = time.time() - start_time
                
                # è®°å½•æ€§èƒ½æŒ‡æ ‡
                if metric_name == 'variable_resolution':
                    VARIABLE_RESOLUTION_TIME.observe(duration)
                elif metric_name == 'data_extraction':
                    DATA_EXTRACTION_TIME.observe(duration)
                
                # è®°å½•é€šç”¨è¯·æ±‚æŒ‡æ ‡
                REQUEST_TIME.observe(duration)
                REQUEST_COUNT.labels(
                    method=getattr(f, 'method', 'unknown'),
                    endpoint=f.__name__,
                    status=status
                ).inc()
        
        return decorated_function
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@monitor_performance('variable_resolution')
def resolve_variables(text, context):
    # ... å˜é‡è§£æé€»è¾‘
    pass

# å¯åŠ¨ç›‘æ§æœåŠ¡å™¨
def start_monitoring():
    start_http_server(8000)
    print("Performance monitoring started on port 8000")
```

---

## ğŸ“ˆ æ€§èƒ½å’Œæ‰©å±•æ€§æ¶æ„

### æ€§èƒ½ç›®æ ‡å’ŒSLA
| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹å¼ |
|------|--------|----------|
| æ™ºèƒ½æç¤ºå“åº”æ—¶é—´ | < 200ms | P95å“åº”æ—¶é—´ |
| å˜é‡è§£ææ—¶é—´ | < 500ms | å¹³å‡å¤„ç†æ—¶é—´ |
| æ•°æ®æå–æ—¶é—´ | < 10s | P90å“åº”æ—¶é—´ |
| å¹¶å‘æ‰§è¡Œèƒ½åŠ› | 100+ | åŒæ—¶æ‰§è¡Œçš„æµ‹è¯•ç”¨ä¾‹æ•° |
| æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ | < 100ms | å¹³å‡æŸ¥è¯¢æ—¶é—´ |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.9% | æœˆåº¦å¯ç”¨æ€§ |

### æ‰©å±•æ€§æ¶æ„è®¾è®¡

#### 1. æ°´å¹³æ‰©å±•ç­–ç•¥
```python
# æ•°æ®åˆ†ç‰‡ç­–ç•¥
class ExecutionContextSharding:
    def __init__(self):
        self.shard_count = 8
    
    def get_shard_key(self, execution_id: str) -> int:
        """æ ¹æ®æ‰§è¡ŒIDè®¡ç®—åˆ†ç‰‡é”®"""
        return hash(execution_id) % self.shard_count
    
    def get_table_name(self, execution_id: str) -> str:
        """è·å–åˆ†ç‰‡è¡¨å"""
        shard_key = self.get_shard_key(execution_id)
        return f"execution_contexts_{shard_key}"
    
    def route_query(self, execution_id: str, query_func):
        """è·¯ç”±æŸ¥è¯¢åˆ°æ­£ç¡®çš„åˆ†ç‰‡"""
        table_name = self.get_table_name(execution_id)
        return query_func(table_name)

# è¯»å†™åˆ†ç¦»é…ç½®
class DatabaseRouter:
    def __init__(self):
        self.master_db = get_master_connection()
        self.slave_dbs = get_slave_connections()
        self.current_slave = 0
    
    def get_read_connection(self):
        """è·å–è¯»è¿æ¥ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰"""
        connection = self.slave_dbs[self.current_slave]
        self.current_slave = (self.current_slave + 1) % len(self.slave_dbs)
        return connection
    
    def get_write_connection(self):
        """è·å–å†™è¿æ¥"""
        return self.master_db
```

#### 2. ç¼“å­˜æ¶æ„è®¾è®¡
```python
import redis
from functools import wraps
import pickle
import json

class VariableCacheManager:
    def __init__(self):
        self.redis_client = redis.Redis(
            host=os.getenv('REDIS_HOST', 'localhost'),
            port=int(os.getenv('REDIS_PORT', 6379)),
            db=int(os.getenv('REDIS_DB', 0)),
            decode_responses=False
        )
        self.default_ttl = 3600  # 1å°æ—¶
    
    def cache_variable(self, execution_id: str, variable_name: str, data: dict, ttl: int = None):
        """ç¼“å­˜å˜é‡æ•°æ®"""
        cache_key = f"var:{execution_id}:{variable_name}"
        serialized_data = pickle.dumps(data)
        self.redis_client.setex(cache_key, ttl or self.default_ttl, serialized_data)
    
    def get_cached_variable(self, execution_id: str, variable_name: str) -> dict:
        """è·å–ç¼“å­˜çš„å˜é‡æ•°æ®"""
        cache_key = f"var:{execution_id}:{variable_name}"
        cached_data = self.redis_client.get(cache_key)
        if cached_data:
            return pickle.loads(cached_data)
        return None
    
    def cache_suggestion_data(self, testcase_id: str, suggestions: list, ttl: int = 300):
        """ç¼“å­˜æ™ºèƒ½æç¤ºæ•°æ®"""
        cache_key = f"suggestions:{testcase_id}"
        self.redis_client.setex(cache_key, ttl, json.dumps(suggestions))
    
    def get_cached_suggestions(self, testcase_id: str) -> list:
        """è·å–ç¼“å­˜çš„æ™ºèƒ½æç¤ºæ•°æ®"""
        cache_key = f"suggestions:{testcase_id}"
        cached_data = self.redis_client.get(cache_key)
        if cached_data:
            return json.loads(cached_data)
        return None

def cache_result(cache_key_func, ttl=3600):
    """ç¼“å­˜è£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            cache_manager = VariableCacheManager()
            cache_key = cache_key_func(*args, **kwargs)
            
            # å°è¯•ä»ç¼“å­˜è·å–
            cached_result = cache_manager.redis_client.get(cache_key)
            if cached_result:
                return pickle.loads(cached_result)
            
            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = f(*args, **kwargs)
            serialized_result = pickle.dumps(result)
            cache_manager.redis_client.setex(cache_key, ttl, serialized_result)
            
            return result
        return decorated_function
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@cache_result(lambda testcase_id: f"available_vars:{testcase_id}", ttl=600)
def get_available_variables(testcase_id: str) -> list:
    # ... æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    pass
```

---

## ğŸ”§ å¼€å‘å’Œæµ‹è¯•æ¶æ„

### å¼€å‘ç¯å¢ƒé…ç½®
```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: intent_test_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  midscene-server:
    build:
      context: .
      dockerfile: Dockerfile.midscene
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - .:/app
      - /app/node_modules

  flask-app:
    build:
      context: .
      dockerfile: Dockerfile.flask
    ports:
      - "5001:5001"
    environment:
      - FLASK_ENV=development
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/intent_test_dev
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - .:/app
    depends_on:
      - postgres
      - redis
      - midscene-server

volumes:
  postgres_data:
  redis_data:
```

### æµ‹è¯•æ¶æ„è®¾è®¡
```python
# tests/conftest.py
import pytest
from unittest.mock import Mock, patch
from web_gui.app_enhanced import create_app
from web_gui.models import db, TestCase, ExecutionHistory
import os

@pytest.fixture(scope='session')
def app():
    """åˆ›å»ºæµ‹è¯•åº”ç”¨å®ä¾‹"""
    app = create_app({
        'TESTING': True,
        'SQLALCHEMY_DATABASE_URI': 'sqlite:///:memory:',
        'WTF_CSRF_ENABLED': False
    })
    
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
    return app.test_client()

@pytest.fixture
def execution_context():
    """æ¨¡æ‹Ÿæ‰§è¡Œä¸Šä¸‹æ–‡"""
    from web_gui.services.execution_context import ExecutionContextService
    return ExecutionContextService('test_execution_123')

@pytest.fixture
def mock_midscene_server():
    """æ¨¡æ‹ŸMidSceneJSæœåŠ¡å™¨"""
    with patch('requests.post') as mock_post:
        mock_post.return_value.json.return_value = {
            'success': True,
            'data': {'extracted_value': 'test_data'},
            'dataType': 'string'
        }
        yield mock_post

# tests/unit/test_variable_resolver.py
import pytest
from web_gui.services.variable_resolver import VariableResolverService
from web_gui.services.execution_context import ExecutionContextService

class TestVariableResolverService:
    
    def setup_method(self):
        self.execution_context = ExecutionContextService('test_exec_123')
        self.resolver = VariableResolverService(self.execution_context)
        
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        self.execution_context.store_variable(
            'user_info', 
            {'name': 'John', 'age': 30, 'email': 'john@example.com'},
            'object',
            1
        )
        self.execution_context.store_variable('product_price', 99.99, 'number', 2)
    
    def test_simple_variable_resolution(self):
        """æµ‹è¯•ç®€å•å˜é‡è§£æ"""
        text = "User price is ${product_price}"
        resolved = self.resolver.resolve_string_value(text)
        assert resolved == "User price is 99.99"
    
    def test_nested_property_resolution(self):
        """æµ‹è¯•åµŒå¥—å±æ€§è§£æ"""
        text = "User ${user_info.name} with email ${user_info.email}"
        resolved = self.resolver.resolve_string_value(text)
        assert resolved == "User John with email john@example.com"
    
    def test_undefined_variable_error(self):
        """æµ‹è¯•æœªå®šä¹‰å˜é‡é”™è¯¯"""
        text = "Invalid ${undefined_var}"
        with pytest.raises(VariableNotFoundError):
            self.resolver.resolve_string_value(text)
    
    def test_invalid_property_error(self):
        """æµ‹è¯•æ— æ•ˆå±æ€§é”™è¯¯"""
        text = "Invalid ${user_info.invalid_property}"
        with pytest.raises(VariablePropertyError):
            self.resolver.resolve_string_value(text)

# tests/integration/test_dataflow_e2e.py
import pytest
import json

class TestDataflowIntegration:
    
    def test_complete_dataflow_workflow(self, client, mock_midscene_server):
        """æµ‹è¯•å®Œæ•´çš„æ•°æ®æµå·¥ä½œæµ"""
        
        # 1. åˆ›å»ºåŒ…å«æ•°æ®æå–æ­¥éª¤çš„æµ‹è¯•ç”¨ä¾‹
        testcase_data = {
            'name': 'æ•°æ®æµæµ‹è¯•ç”¨ä¾‹',
            'description': 'æµ‹è¯•æ•°æ®æå–å’Œå˜é‡å¼•ç”¨',
            'steps': [
                {
                    'action': 'navigate',
                    'params': {'url': 'https://example.com'},
                    'description': 'è®¿é—®æµ‹è¯•é¡µé¢'
                },
                {
                    'action': 'ai_extract_object',
                    'params': {
                        'query': 'æå–ç”¨æˆ·ä¿¡æ¯',
                        'data_schema': '{"name": "string", "age": "number"}',
                        'output_variable': 'user_data'
                    },
                    'description': 'æå–ç”¨æˆ·æ•°æ®'
                },
                {
                    'action': 'ai_input',
                    'params': {
                        'text': 'Hello ${user_data.name}',
                        'locate': 'æ¶ˆæ¯è¾“å…¥æ¡†'
                    },
                    'description': 'ä½¿ç”¨æå–çš„ç”¨æˆ·å'
                }
            ]
        }
        
        # åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
        response = client.post('/api/v1/testcases/', 
                             data=json.dumps(testcase_data),
                             content_type='application/json')
        assert response.status_code == 201
        testcase_id = response.json['data']['id']
        
        # 2. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
        response = client.post(f'/api/v1/testcases/{testcase_id}/execute',
                             data=json.dumps({'mode': 'headless'}),
                             content_type='application/json')
        assert response.status_code == 200
        execution_id = response.json['data']['execution_id']
        
        # 3. éªŒè¯å˜é‡æ•°æ®è¢«æ­£ç¡®å­˜å‚¨
        response = client.get(f'/api/v1/executions/{execution_id}/variables')
        assert response.status_code == 200
        variables = response.json['data']
        
        # éªŒè¯ç”¨æˆ·æ•°æ®å˜é‡å­˜åœ¨
        user_data_var = next((v for v in variables if v['variable_name'] == 'user_data'), None)
        assert user_data_var is not None
        assert user_data_var['variable_type'] == 'object'
        
        # 4. éªŒè¯å˜é‡å¼•ç”¨è¢«æ­£ç¡®è§£æ
        # é€šè¿‡æŸ¥çœ‹æ­¥éª¤æ‰§è¡Œå†å²éªŒè¯å˜é‡æ›¿æ¢
        response = client.get(f'/api/v1/executions/{execution_id}/steps')
        assert response.status_code == 200
        step_executions = response.json['data']
        
        # æ‰¾åˆ°ç¬¬ä¸‰ä¸ªæ­¥éª¤ï¼ˆä½¿ç”¨å˜é‡çš„æ­¥éª¤ï¼‰
        input_step = next((s for s in step_executions if s['step_index'] == 2), None)
        assert input_step is not None
        # éªŒè¯å‚æ•°ä¸­çš„å˜é‡å·²è¢«è§£æ
        # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æ‰§è¡Œç»“æœéªŒè¯
    
    def test_variable_validation_api(self, client):
        """æµ‹è¯•å˜é‡éªŒè¯API"""
        
        # åˆ›å»ºå¸¦æœ‰å˜é‡å¼•ç”¨çš„æ­¥éª¤
        step_data = {
            'action': 'ai_input',
            'params': {
                'text': 'Hello ${user_name} and ${user_age}',
                'locate': 'input field'
            }
        }
        
        # å¯ç”¨å˜é‡åˆ—è¡¨
        available_variables = ['user_name', 'user_email']  # æ³¨æ„ï¼šuser_ageä¸åœ¨å¯ç”¨åˆ—è¡¨ä¸­
        
        # éªŒè¯æ­¥éª¤
        response = client.post('/api/v1/steps/validate',
                             data=json.dumps({
                                 'step': step_data,
                                 'available_variables': available_variables
                             }),
                             content_type='application/json')
        
        assert response.status_code == 200
        validation_result = response.json['data']
        
        # åº”è¯¥æœ‰ä¸€ä¸ªé”™è¯¯ï¼šuser_ageå˜é‡æœªå®šä¹‰
        assert len(validation_result['errors']) == 1
        assert 'user_age' in validation_result['errors'][0]
    
    def test_intelligent_suggestions_api(self, client):
        """æµ‹è¯•æ™ºèƒ½æç¤ºAPI"""
        
        # åˆ›å»ºä¸€ä¸ªåŒ…å«å˜é‡çš„æµ‹è¯•ç”¨ä¾‹
        testcase_data = {
            'name': 'æµ‹è¯•ç”¨ä¾‹',
            'steps': [
                {
                    'action': 'ai_extract_string',
                    'params': {
                        'query': 'æå–äº§å“åç§°',
                        'output_variable': 'product_name'
                    }
                },
                {
                    'action': 'ai_extract_number', 
                    'params': {
                        'query': 'æå–äº§å“ä»·æ ¼',
                        'output_variable': 'product_price'
                    }
                }
            ]
        }
        
        response = client.post('/api/v1/testcases/',
                             data=json.dumps(testcase_data),
                             content_type='application/json')
        testcase_id = response.json['data']['id']
        
        # è·å–å˜é‡å»ºè®®
        response = client.get(f'/api/v1/testcases/{testcase_id}/variable-suggestions')
        assert response.status_code == 200
        
        suggestions = response.json['data']
        assert len(suggestions) == 2
        
        # éªŒè¯å»ºè®®åŒ…å«æ­£ç¡®çš„å˜é‡ä¿¡æ¯
        product_name_suggestion = next((s for s in suggestions if s['name'] == 'product_name'), None)
        assert product_name_suggestion is not None
        assert product_name_suggestion['type'] == 'string'
        assert product_name_suggestion['source_step'] == 1
```

---

## ğŸ“š æ€»ç»“ä¸å»ºè®®

### æ¶æ„äº®ç‚¹
1. **æ¸è¿›å¼æ¶æ„**: åœ¨ç°æœ‰ç³»ç»ŸåŸºç¡€ä¸Šå¹³æ»‘æ‰©å±•ï¼Œä¿æŒå‘åå…¼å®¹æ€§
2. **ç”¨æˆ·ä½“éªŒé©±åŠ¨**: æ™ºèƒ½æç¤ºå’Œè¡¨å•åŒ–é…ç½®æ˜¾è‘—æå‡æ˜“ç”¨æ€§
3. **æ€§èƒ½ä¼˜åŒ–**: å¤šå±‚ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†ç¡®ä¿ç³»ç»Ÿå“åº”æ€§èƒ½
4. **å®‰å…¨å¯é **: å®Œæ•´çš„æ•°æ®åŠ å¯†ã€æƒé™æ§åˆ¶å’Œé”™è¯¯å¤„ç†æœºåˆ¶
5. **å¯æ‰©å±•æ¶æ„**: æ”¯æŒæ°´å¹³æ‰©å±•å’ŒåŠŸèƒ½æ¨¡å—åŒ–æ‰©å±•

### å®æ–½å»ºè®®

#### çŸ­æœŸå®æ–½é‡ç‚¹ï¼ˆ1-2ä¸ªæœˆï¼‰
1. **æ ¸å¿ƒæ•°æ®æµåŠŸèƒ½**: ä¼˜å…ˆå®ç°å˜é‡è§£æå’Œæ•°æ®æå–åŠŸèƒ½
2. **æ™ºèƒ½æç¤ºç³»ç»Ÿ**: é‡ç‚¹ä¼˜åŒ–ç”¨æˆ·è¾“å…¥ä½“éªŒ
3. **æ•°æ®åº“è¿ç§»**: å®‰å…¨å¯é çš„æ•°æ®æ¨¡å‹å‡çº§

#### ä¸­æœŸä¼˜åŒ–ç›®æ ‡ï¼ˆ3-6ä¸ªæœˆï¼‰
1. **æ€§èƒ½è°ƒä¼˜**: åŸºäºçœŸå®ä½¿ç”¨æ•°æ®è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
2. **ç”¨æˆ·åé¦ˆè¿­ä»£**: æ ¹æ®ç”¨æˆ·ä½¿ç”¨æƒ…å†µä¼˜åŒ–åŠŸèƒ½è®¾è®¡
3. **æ‰©å±•åŠŸèƒ½**: å®ç°é«˜çº§æ•°æ®æ“ä½œå’Œå¯è§†åŒ–åŠŸèƒ½

#### é•¿æœŸå‘å±•æ–¹å‘ï¼ˆ6-12ä¸ªæœˆï¼‰
1. **AIå¢å¼º**: é›†æˆæ›´å…ˆè¿›çš„AIèƒ½åŠ›æå‡è‡ªåŠ¨åŒ–ç¨‹åº¦
2. **ä¼ä¸šçº§åŠŸèƒ½**: å¤šç§Ÿæˆ·ã€æƒé™ç®¡ç†ã€å®¡è®¡æ—¥å¿—ç­‰
3. **ç”Ÿæ€å»ºè®¾**: æ’ä»¶ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹é›†æˆã€ç¤¾åŒºæ¨¡æ¿

### é£é™©è¯„ä¼°ä¸ç¼“è§£

#### æŠ€æœ¯é£é™©
- **é£é™©**: MidSceneJS APIå˜æ›´å½±å“é›†æˆ
- **ç¼“è§£**: ç‰ˆæœ¬é”å®šå’Œé€‚é…å±‚è®¾è®¡

#### æ€§èƒ½é£é™©  
- **é£é™©**: å¤§é‡å˜é‡å¤„ç†å½±å“ç³»ç»Ÿæ€§èƒ½
- **ç¼“è§£**: åˆ†å±‚ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†æ¶æ„

#### å…¼å®¹æ€§é£é™©
- **é£é™©**: æ–°åŠŸèƒ½å½±å“ç°æœ‰æµ‹è¯•ç”¨ä¾‹
- **ç¼“è§£**: å®Œæ•´çš„å‘åå…¼å®¹æ€§æµ‹è¯•å’Œæ¸è¿›å¼å‘å¸ƒ

### æˆåŠŸå…³é”®å› ç´ 
1. **å›¢é˜Ÿåä½œ**: å‰åç«¯ã€AIå¼•æ“å›¢é˜Ÿçš„ç´§å¯†é…åˆ
2. **ç”¨æˆ·å‚ä¸**: æŒç»­çš„ç”¨æˆ·åé¦ˆå’Œéœ€æ±‚éªŒè¯
3. **è´¨é‡ä¿è¯**: å®Œå–„çš„æµ‹è¯•è¦†ç›–å’Œè´¨é‡é—¨ç¦
4. **ç›‘æ§ä½“ç³»**: å…¨é¢çš„æ€§èƒ½ç›‘æ§å’Œç”¨æˆ·è¡Œä¸ºåˆ†æ

è¿™ä¸ªå…¨æ ˆæ¶æ„è®¾è®¡ä¸ºIntent Test Frameworkçš„æ•°æ®æµåŠŸèƒ½æä¾›äº†å®Œæ•´çš„æŠ€æœ¯å®ç°è·¯å¾„ï¼Œæ—¢ä¿è¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§å’Œå…ˆè¿›æ€§ï¼Œåˆç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚é€šè¿‡åˆ†é˜¶æ®µå®æ–½ï¼Œå¯ä»¥åœ¨æ§åˆ¶é£é™©çš„åŒæ—¶é€æ­¥é‡Šæ”¾ä»·å€¼ï¼Œæœ€ç»ˆå®ç°ç”¨æˆ·ä½“éªŒçš„æ˜¾è‘—æå‡ã€‚

---

*æœ¬æ¶æ„æ–‡æ¡£å°†éšç€é¡¹ç›®è¿›å±•æŒç»­æ›´æ–°å’Œå®Œå–„ã€‚å¦‚æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–æ¶æ„ç–‘é—®ï¼Œè¯·åŠæ—¶æ²Ÿé€šè®¨è®ºã€‚*