# 数据流功能用户测试场景

## 测试场景概述

本文档提供了一个完整的用户测试场景，用于验证STORY-012实现的数据流功能是否符合预期。场景模拟一个真实的电商网站自动化测试用例，包含多个步骤间的数据传递和变量引用。

## 测试环境准备

### 1. 启动系统
```bash
# 启动Web GUI应用
python web_gui/app_enhanced.py

# 启动MidScene服务器（另一个终端）
node midscene_server.js
```

### 2. 访问测试页面
- 打开浏览器访问：`http://localhost:5000`
- 点击"测试用例管理"进入测试用例列表

## 详细测试场景：电商网站用户注册和购买流程

### 场景描述
模拟用户在电商网站完成注册、登录、搜索商品、查看详情、加入购物车、结算的完整流程，重点测试步骤间的数据传递功能。

---

## 步骤1：创建新测试用例

### 用户操作
1. 点击"新建测试用例"按钮
2. 输入测试用例基本信息：
   - **名称**：`电商网站完整购买流程测试`
   - **描述**：`测试用户注册、登录、商品搜索、购买等完整流程，验证数据流功能`

### 预期结果
- 成功创建测试用例
- 进入测试用例编辑页面
- 显示空的步骤列表

---

## 步骤2：添加页面导航步骤

### 用户操作
1. 点击"添加步骤"按钮
2. 配置第一个步骤：
   - **标题**：`打开电商网站首页`
   - **动作类型**：选择`goto`
   - **参数配置**：
     - URL：`https://demo-store.example.com`

### 预期结果
- 步骤添加成功
- 参数字段显示"支持变量"标识
- URL字段显示占位符文本

---

## 步骤3：用户注册步骤（数据输出）

### 用户操作
1. 添加新步骤
2. 配置用户注册步骤：
   - **标题**：`用户注册获取用户信息`
   - **动作类型**：选择`aiQuery`
   - **参数配置**：
     - **查询内容**：`注册新用户并获取用户信息，包括用户名、邮箱、用户ID`
     - **数据结构**：
```json
{
  "username": "string",
  "email": "string", 
  "userId": "string",
  "registrationTime": "string"
}
```

### 预期结果
- 智能字段识别功能正常工作
- Schema字段显示JSON格式验证
- 系统识别这是一个数据输出步骤

---

## 步骤4：用户登录步骤（数据引用）

### 用户操作
1. 添加新步骤
2. 配置登录步骤：
   - **标题**：`使用注册的用户信息进行登录`
   - **动作类型**：选择`aiInput`
   - **参数配置**：
     - **输入文本**：开始输入`${`

### 预期智能提示行为
1. **智能提示触发**：
   - 输入`${`后，应该自动弹出变量提示下拉菜单
   - 显示可用变量列表，包括前面步骤的输出变量

2. **变量提示内容**：
```
📋 可用变量：
┌─────────────────────────────────────────┐
│ ${step_2_result}                        │
│ 类型: object | 来源: 步骤2              │
│ 预览: {username: "...", email: "..."}   │
│                                         │
│ ${step_2_result.username}               │  
│ 类型: string | 来源: 步骤2.username     │
│ 预览: "demo_user_123"                   │
│                                         │
│ ${step_2_result.email}                  │
│ 类型: string | 来源: 步骤2.email        │
│ 预览: "user@example.com"                │
│                                         │
│ ${step_2_result.userId}                 │
│ 类型: string | 来源: 步骤2.userId       │
│ 预览: "usr_789456123"                   │
└─────────────────────────────────────────┘
```

3. **用户选择**：选择`${step_2_result.username}`

### 最终参数配置
- **输入文本**：`${step_2_result.username}`
- **元素定位**：`用户名输入框`

### 预期验证结果
1. **实时预览显示**：
```
预览值: "demo_user_123"
```

2. **字段元信息**：
```
Contains 1 variable reference
```

3. **验证状态**：
   - 输入框边框变为绿色（验证通过）
   - 无错误信息显示

---

## 步骤5：商品搜索步骤（数据输出）

### 用户操作
1. 添加新步骤
2. 配置商品搜索：
   - **标题**：`搜索手机商品`
   - **动作类型**：选择`aiQuery`
   - **参数配置**：
     - **查询内容**：`搜索手机商品，获取第一个商品的详细信息`
     - **数据结构**：
```json
{
  "productName": "string",
  "productId": "string",
  "price": "number",
  "inStock": "boolean",
  "category": "string"
}
```

### 预期结果
- JSON格式验证通过
- 字段元信息显示"Valid JSON"

---

## 步骤6：商品详情查看（复合数据引用）

### 用户操作
1. 添加新步骤
2. 配置商品详情查看：
   - **标题**：`查看商品详情页面`
   - **动作类型**：选择`aiTap`
   - **参数配置**：
     - **元素定位**：开始输入复合引用

### 复合变量引用测试
1. **输入过程**：
   - 输入：`点击商品`
   - 继续输入：`${step_4_result.productName}`
   - 完整输入：`点击商品${step_4_result.productName}的查看详情按钮`

2. **预期智能提示**：
   - 输入`${step_4_result.`时显示对象属性提示
   - 显示productName、productId、price等属性选项

3. **实时预览**：
```
预览值: "点击商品iPhone 15 Pro的查看详情按钮"
```

---

## 步骤7：价格验证步骤（数据验证）

### 用户操作 
1. 添加新步骤
2. 配置价格验证：
   - **标题**：`验证商品价格显示正确`
   - **动作类型**：选择`aiAssert`
   - **参数配置**：
     - **验证条件**：`页面显示的商品价格为${step_4_result.price}元`

### 预期行为
1. **数字类型处理**：
   - 系统识别price为数字类型
   - 正确处理数字格式化

2. **预览显示**：
```
预览值: "页面显示的商品价格为8999元"
```

---

## 步骤8：用户信息引用步骤（跨步骤引用）

### 用户操作
1. 添加结算步骤
2. 配置用户信息验证：
   - **标题**：`确认收货人信息`
   - **动作类型**：选择`aiAssert`
   - **参数配置**：
     - **验证条件**：`收货人姓名显示为${step_2_result.username}，邮箱为${step_2_result.email}`

### 预期多变量处理
1. **多变量识别**：
   - 系统识别文本中包含2个变量引用
   - 字段元信息显示："Contains 2 variable references"

2. **预览效果**：
```
预览值: "收货人姓名显示为demo_user_123，邮箱为user@example.com"
```

---

## 高级功能测试

### 模式切换测试

#### 测试步骤
1. 在任意步骤的编辑模式中
2. 点击"切换到JSON编辑"按钮

#### 预期行为
1. **界面切换**：
   - 增强参数编辑器隐藏
   - JSON文本框显示
   - 按钮文本变为"切换到增强模式"

2. **数据同步**：
   - JSON文本框显示当前参数的完整JSON格式
   - 包含所有已配置的参数

3. **反向切换**：
   - 点击"切换到增强模式"
   - 恢复增强编辑界面
   - 数据保持一致

### 错误处理测试

#### 无效变量引用测试
1. **输入无效引用**：`${nonexistent_variable}`
2. **预期错误提示**：
```
❌ 变量引用错误: 变量 'nonexistent_variable' 不存在
建议: 请检查变量名称是否正确，或确认该变量在当前步骤之前已定义
```

#### 语法错误测试
1. **输入语法错误**：`${invalid.syntax[}`
2. **预期错误提示**：
```
❌ 变量引用语法错误
建议: 使用格式: ${variable_name} 或 ${object.property} 或 ${array[index]}
```

---

## 性能测试验证

### 防抖功能测试
1. **快速连续输入**：在支持变量的字段中快速输入变量引用
2. **预期行为**：
   - 验证请求被防抖处理，不会频繁调用API
   - 最终验证结果正确显示

### 缓存功能测试
1. **重复操作**：多次输入相同的变量引用
2. **预期行为**：
   - 第二次及以后的验证使用缓存结果
   - 响应速度明显提升

---

## 完整测试验证清单

### ✅ 基础功能验证
- [ ] 智能变量提示正常触发（输入`${`时）
- [ ] 变量列表显示完整且准确
- [ ] 变量选择后正确插入到输入框
- [ ] 实时预览功能正常工作
- [ ] 字段验证状态正确显示

### ✅ 数据流功能验证
- [ ] 跨步骤变量引用正常工作
- [ ] 复杂对象属性访问正确
- [ ] 多变量引用同时处理正确
- [ ] 不同数据类型正确处理

### ✅ 用户体验验证
- [ ] 界面响应速度良好
- [ ] 错误提示信息清晰有用
- [ ] 模式切换功能正常
- [ ] 移动端适配良好

### ✅ 性能验证
- [ ] 防抖功能有效降低API调用频率
- [ ] 缓存机制提升重复操作性能
- [ ] 大量变量时界面仍然流畅

---

## 预期测试结果

如果所有功能正常，用户应该能够：

1. **流畅创建**包含数据流的复杂测试用例
2. **直观理解**步骤间的数据传递关系
3. **快速定位**和修复变量引用错误
4. **高效编辑**参数，享受IDE级别的智能提示体验
5. **灵活切换**增强模式和JSON模式进行编辑

## 问题反馈

如果在测试过程中发现任何问题，请记录：

1. **问题描述**：具体的异常行为
2. **复现步骤**：导致问题的操作序列
3. **预期行为**：应该发生什么
4. **实际行为**：实际发生了什么
5. **浏览器信息**：浏览器版本和操作系统
6. **控制台日志**：相关的错误日志信息

测试完成后，这个场景将验证数据流功能是否达到了STORY-012的设计目标。