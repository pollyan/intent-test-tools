# STORY-007: å®ç°output_variableå‚æ•°è§£æå’Œå­˜å‚¨

**Story ID**: STORY-007  
**Epic**: EPIC-001 æ•°æ®æµæ ¸å¿ƒåŠŸèƒ½  
**Sprint**: Sprint 2  
**ä¼˜å…ˆçº§**: High  
**ä¼°ç®—**: 5 Story Points  
**åˆ†é…ç»™**: Backend Developer + å…¨æ ˆå·¥ç¨‹å¸ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-30  
**äº§å“ç»ç†**: John  

---

## ğŸ“– æ•…äº‹æè¿°

**ä½œä¸º** æµ‹è¯•å·¥ç¨‹å¸ˆ  
**æˆ‘å¸Œæœ›** åœ¨ç°æœ‰çš„Midscene API Actionä¸­æ·»åŠ `output_variable`å‚æ•°  
**ä»¥ä¾¿** æˆ‘å¯ä»¥å°†APIæ–¹æ³•çš„è¿”å›å€¼ä¿å­˜ä¸ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨  
**è¿™æ ·** æˆ‘å°±èƒ½åˆ›å»ºæ•°æ®é©±åŠ¨çš„æµ‹è¯•æµç¨‹ï¼Œé¿å…é‡å¤çš„æ•°æ®æå–æ“ä½œ  

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### AC-1: æ”¯æŒoutput_variableå‚æ•°é…ç½®
**ç»™å®š** æˆ‘åœ¨ç¼–è¾‘æµ‹è¯•æ­¥éª¤æ—¶  
**å½“** æˆ‘ä¸ºæœ‰è¿”å›å€¼çš„Actionæ·»åŠ `output_variable`å‚æ•°  
**é‚£ä¹ˆ** ç³»ç»Ÿåº”è¯¥éªŒè¯å‚æ•°æ ¼å¼å¹¶ä¿å­˜é…ç½®  

**ç¤ºä¾‹é…ç½®**:
```json
{
  "action": "aiQuery",
  "params": {
    "query": "æå–å•†å“ä»·æ ¼å’Œåº“å­˜ä¿¡æ¯",
    "dataDemand": "{price: number, stock: number}"
  },
  "output_variable": "product_info",
  "description": "æå–å•†å“åŸºæœ¬ä¿¡æ¯"
}
```

### AC-2: è¿”å›å€¼è‡ªåŠ¨æ•è·å’Œå­˜å‚¨
**ç»™å®š** æµ‹è¯•æ­¥éª¤é…ç½®äº†`output_variable`å‚æ•°  
**å½“** æ‰§è¡Œå¯¹åº”çš„Midscene APIæ–¹æ³•  
**é‚£ä¹ˆ** ç³»ç»Ÿåº”è¯¥è‡ªåŠ¨æ•è·è¿”å›å€¼å¹¶å­˜å‚¨åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­  

**è¯¦ç»†è¦æ±‚**:
- æ”¯æŒçš„APIæ–¹æ³•ï¼šaiQuery, aiString, aiNumber, aiBoolean, aiAsk, aiLocate, evaluateJavaScript
- è‡ªåŠ¨æ£€æµ‹è¿”å›å€¼æ•°æ®ç±»å‹
- å­˜å‚¨åˆ°æ•°æ®åº“çš„execution_variablesè¡¨
- è®°å½•å˜é‡æ¥æºï¼ˆæ­¥éª¤ç´¢å¼•ã€APIæ–¹æ³•ã€å‚æ•°ï¼‰

### AC-3: æ•°æ®ç±»å‹æ­£ç¡®è¯†åˆ«å’Œå­˜å‚¨
**ç»™å®š** APIæ–¹æ³•è¿”å›ä¸åŒç±»å‹çš„æ•°æ®  
**å½“** ç³»ç»Ÿæ•è·è¿”å›å€¼  
**é‚£ä¹ˆ** åº”è¯¥æ­£ç¡®è¯†åˆ«æ•°æ®ç±»å‹å¹¶ä»¥é€‚å½“æ ¼å¼å­˜å‚¨  

**æ•°æ®ç±»å‹æ”¯æŒ**:
- `string`: å­—ç¬¦ä¸²ç±»å‹
- `number`: æ•°å­—ç±»å‹ï¼ˆæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼‰
- `boolean`: å¸ƒå°”å€¼ç±»å‹
- `object`: å¤æ‚å¯¹è±¡ç±»å‹
- `array`: æ•°ç»„ç±»å‹

### AC-4: é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
**ç»™å®š** APIæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯  
**å½“** å°è¯•æ•è·è¿”å›å€¼æ—¶  
**é‚£ä¹ˆ** ç³»ç»Ÿåº”è¯¥è®°å½•é”™è¯¯ä¿¡æ¯å¹¶ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤  

**é”™è¯¯åœºæ™¯**:
- APIæ–¹æ³•æ‰§è¡Œå¤±è´¥
- è¿”å›å€¼æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
- å˜é‡åç§°æ ¼å¼ä¸æ­£ç¡®
- æ•°æ®åº“å­˜å‚¨å¤±è´¥

### AC-5: å‘åå…¼å®¹æ€§ä¿è¯
**ç»™å®š** ç°æœ‰æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰ä½¿ç”¨`output_variable`å‚æ•°  
**å½“** æ‰§è¡Œè¿™äº›æµ‹è¯•ç”¨ä¾‹  
**é‚£ä¹ˆ** ç³»ç»Ÿåº”è¯¥æ­£å¸¸æ‰§è¡Œï¼Œä¸å—æ–°åŠŸèƒ½å½±å“  

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦æ±‚

### åç«¯å®ç° (Flask)
1. **APIè·¯ç”±æ‰©å±•**
   - ä¿®æ”¹`/api/v1/testcases/{id}/execute`ç«¯ç‚¹
   - æ”¯æŒoutput_variableå‚æ•°è§£æ
   - é›†æˆå˜é‡å­˜å‚¨é€»è¾‘

2. **æ•°æ®åº“æ“ä½œ**
   - å®ç°ExecutionVariableæ¨¡å‹çš„CRUDæ“ä½œ
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ˆç´¢å¼•ç­–ç•¥ï¼‰
   - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

3. **æœåŠ¡å±‚ç»„ä»¶**
   ```python
   class VariableStorageService:
       def store_variable(self, execution_id, variable_name, value, metadata)
       def get_variable(self, execution_id, variable_name)
       def list_variables(self, execution_id)
   ```

### MidSceneJSé›†æˆ
1. **æ­¥éª¤æ‰§è¡Œå™¨å¢å¼º**
   - ä¿®æ”¹enhanced_step_executor.py
   - ä¸ºæ¯ä¸ªæœ‰è¿”å›å€¼çš„APIæ–¹æ³•æ·»åŠ æ•è·é€»è¾‘
   - å®ç°ç±»å‹æ£€æµ‹å’Œè½¬æ¢

2. **æ‰§è¡Œæµç¨‹ä¿®æ”¹**
   ```python
   # æ‰§è¡ŒAPIæ–¹æ³•
   result = await page.aiQuery(params.query, params.dataDemand)
   
   # å¦‚æœé…ç½®äº†è¾“å‡ºå˜é‡ï¼Œåˆ™å­˜å‚¨ç»“æœ
   if step.get('output_variable'):
       variable_manager.store_variable(
           variable_name=step['output_variable'],
           value=result,
           source_step_index=step_index,
           source_api_method='aiQuery',
           source_api_params=params
       )
   ```

### æ•°æ®æ¨¡å‹
```python
class ExecutionVariable(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    execution_id = db.Column(db.String(50), nullable=False)
    variable_name = db.Column(db.String(255), nullable=False)
    variable_value = db.Column(db.Text)  # JSONå­˜å‚¨
    data_type = db.Column(db.String(50), nullable=False)
    source_step_index = db.Column(db.Integer, nullable=False)
    source_api_method = db.Column(db.String(100))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
1. **å˜é‡å­˜å‚¨åŠŸèƒ½æµ‹è¯•**
   - æµ‹è¯•å„ç§æ•°æ®ç±»å‹çš„å­˜å‚¨
   - æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ
   - æµ‹è¯•å¹¶å‘è®¿é—®å®‰å…¨æ€§

2. **APIæ–¹æ³•é›†æˆæµ‹è¯•**
   - æµ‹è¯•æ¯ä¸ªæœ‰è¿”å›å€¼çš„Midscene APIæ–¹æ³•
   - éªŒè¯è¿”å›å€¼æ•è·çš„å‡†ç¡®æ€§
   - æµ‹è¯•é”™è¯¯åœºæ™¯å¤„ç†

### é›†æˆæµ‹è¯•
1. **ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯**
   ```json
   [
     {
       "action": "navigate",
       "params": {"url": "https://example-shop.com"}
     },
     {
       "action": "aiQuery",
       "params": {
         "query": "æå–å•†å“ä»·æ ¼",
         "dataDemand": "{price: number}"
       },
       "output_variable": "product_price"
     },
     {
       "action": "ai_assert",
       "params": {
         "condition": "ä»·æ ¼æ˜¾ç¤ºä¸º${product_price}"
       }
     }
   ]
   ```

2. **æ€§èƒ½æµ‹è¯•**
   - å¤§é‡å˜é‡å­˜å‚¨çš„æ€§èƒ½æµ‹è¯•
   - å¹¶å‘æ‰§è¡Œçš„æ•°æ®éš”ç¦»æµ‹è¯•
   - å†…å­˜ä½¿ç”¨å’Œæ•°æ®åº“æ€§èƒ½æµ‹è¯•

---

## ğŸ“Š Definition of Done

- [ ] **ä»£ç å®Œæˆ**: æ‰€æœ‰åŠŸèƒ½ä»£ç ç¼–å†™å®Œæˆå¹¶é€šè¿‡ä»£ç å®¡æŸ¥
- [ ] **å•å…ƒæµ‹è¯•**: æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°90%ä»¥ä¸Šï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯é€šè¿‡
- [ ] **æ–‡æ¡£æ›´æ–°**: APIæ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—æ›´æ–°
- [ ] **æ€§èƒ½éªŒè¯**: å˜é‡å­˜å‚¨æ“ä½œå“åº”æ—¶é—´<500ms
- [ ] **å®‰å…¨å®¡æŸ¥**: æ•°æ®å­˜å‚¨å®‰å…¨æ€§å®¡æŸ¥é€šè¿‡
- [ ] **å‘åå…¼å®¹**: ç°æœ‰æµ‹è¯•ç”¨ä¾‹100%å…¼å®¹
- [ ] **äº§å“éªŒæ”¶**: äº§å“ç»ç†éªŒæ”¶é€šè¿‡

---

## ğŸ”— ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–**:
- STORY-001: ExecutionContextæ•°æ®æ¨¡å‹å·²å®Œæˆ
- STORY-002: æ•°æ®åº“Schemaè¿ç§»å·²éƒ¨ç½²
- STORY-003: VariableResolverServiceåŸºç¡€æ¶æ„å°±ç»ª

**åç»­ä¾èµ–**:
- STORY-008: å˜é‡å¼•ç”¨è¯­æ³•è§£æï¼ˆä¾èµ–æ­¤Storyçš„å˜é‡å­˜å‚¨åŠŸèƒ½ï¼‰
- STORY-009: é›†æˆå˜é‡è§£æåˆ°æ­¥éª¤æ‰§è¡Œæµç¨‹

---

## ğŸ’¡ æŠ€æœ¯æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**
   - å˜é‡æ•°æ®ä½¿ç”¨JSONæ ¼å¼å­˜å‚¨ï¼Œä¾¿äºå¤æ‚å¯¹è±¡å¤„ç†
   - å®æ–½å˜é‡æ•°æ®ç¼“å­˜ç­–ç•¥ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - ä¸ºexecution_id + variable_nameå»ºç«‹å¤åˆç´¢å¼•

2. **å®‰å…¨è€ƒè™‘**
   - æ•æ„Ÿæ•°æ®å˜é‡æ”¯æŒåŠ å¯†å­˜å‚¨
   - å˜é‡è®¿é—®æƒé™æ§åˆ¶
   - SQLæ³¨å…¥é˜²æŠ¤

3. **å¯æ‰©å±•æ€§**
   - æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹æ‰©å±•
   - å˜é‡å…ƒæ•°æ®æ”¯æŒæ‰©å±•å­—æ®µ
   - é¢„ç•™å˜é‡è½¬æ¢å’ŒéªŒè¯é’©å­

---

**çŠ¶æ€**: å¾…å¼€å§‹  
**åˆ›å»ºäºº**: John (Product Manager)  
**æœ€åæ›´æ–°**: 2025-01-30  

*æ­¤ç”¨æˆ·æ•…äº‹å°†æ ¹æ®å¼€å‘è¿›å±•å’Œåé¦ˆæŒç»­æ›´æ–°*