# 修复测试问题指南

## 🔍 问题诊断

从您的测试日志分析出两个主要问题：

### 问题1: AI模型服务连接失败 ❌
**错误信息**: `failed to call AI model service: Connection error`

**原因**: 环境变量中的API密钥未配置
```bash
# 当前.env文件中API配置被注释
# OPENAI_API_KEY=your-api-key-here
# OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

### 问题2: 变量引用格式错误 ❌  
**错误格式**: `"text": "step_2_result.Accepted usernames"`  
**正确格式**: `"text": "${step_2_result.Accepted usernames}"`

## 🔧 解决方案

### 解决方案1: 配置AI API（用于完整测试）

如果您有API密钥，请编辑`.env`文件：

```bash
# 取消注释并填入真实密钥
OPENAI_API_KEY=your-actual-api-key
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
MIDSCENE_MODEL_NAME=qwen-vl-max-latest
```

### 解决方案2: 测试数据流功能（推荐）

**即使没有AI API，数据流功能仍可完整测试！**

数据流功能主要在Web界面中工作，不依赖MidScene的AI执行。

## 🎯 专注测试数据流功能

### 测试重点：Web界面的智能提示功能

1. **访问Web界面**: http://localhost:5001
2. **进入测试用例编辑器**
3. **测试智能变量提示**：
   - 添加输出变量的步骤
   - 在后续步骤中输入`${`
   - 观察智能提示下拉菜单
   - 验证变量引用功能

### 创建测试用例验证数据流

#### 步骤1: 创建输出变量步骤
```json
{
  "action": "aiQuery",
  "description": "获取用户信息",
  "params": {
    "query": "获取用户登录信息",
    "schema": {
      "username": "string",
      "email": "string"
    }
  },
  "output-variable": "userInfo"
}
```

#### 步骤2: 测试变量引用
```json
{
  "action": "aiInput", 
  "description": "输入用户名",
  "params": {
    "text": "${userInfo.username}",  // 正确格式
    "locate": "用户名输入框"
  }
}
```

## 🧪 数据流功能验证步骤

### 1. 打开测试用例编辑器
- 访问: http://localhost:5001
- 点击"测试用例管理" → "新建测试用例"

### 2. 添加第一个步骤（数据输出）
- 动作类型: `aiQuery`
- 在参数中设置output-variable: `myData`

### 3. 添加第二个步骤（数据引用）
- 动作类型: `aiInput`
- 在"输入文本"字段输入: `${`
- **关键测试点**: 观察是否弹出智能提示菜单
- **验证**: 是否显示`myData`变量

### 4. 测试智能提示功能
- [ ] 输入`${`时自动弹出提示
- [ ] 显示可用变量列表
- [ ] 支持属性访问如`${myData.property}`
- [ ] 实时预览变量值
- [ ] 语法错误时显示错误提示

## 🎉 预期测试结果

如果数据流功能正常，您应该看到：

✅ **智能变量提示**: 输入`${`时弹出下拉菜单  
✅ **变量列表**: 显示之前步骤定义的变量  
✅ **属性提示**: 支持对象属性访问提示  
✅ **实时预览**: 显示变量解析结果预览  
✅ **错误验证**: 无效引用时显示错误信息  
✅ **模式切换**: 增强模式与JSON模式切换正常  

## 🚀 下一步建议

1. **先测试数据流功能**（Web界面功能）
2. **确认智能提示工作正常**
3. **如需完整AI执行测试，再配置API密钥**

## 💡 重要提醒

**数据流功能 ≠ AI执行功能**

- **数据流功能**: 在Web界面中的智能变量提示、引用、验证等（已实现）
- **AI执行功能**: MidScene实际执行AI操作（需要API密钥）

您可以先完整测试数据流功能，这是STORY-012的核心内容！

---

**问题修复优先级**:
1. 🥇 测试Web界面数据流功能（立即可测试）
2. 🥈 修复变量引用格式（如果要执行测试）
3. 🥉 配置AI API密钥（如果要完整执行测试）