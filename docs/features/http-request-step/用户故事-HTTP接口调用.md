# HTTP接口调用功能用户故事

## 文档信息
- **功能名称**: HTTP接口调用步骤
- **版本**: v1.0  
- **创建日期**: 2025-08-16
- **文档类型**: 用户故事文档
- **状态**: 需求完成

## 📋 目录
1. [Epic概述](#epic概述)
2. [用户故事列表](#用户故事列表)
3. [验收标准](#验收标准)
4. [非功能需求](#非功能需求)
5. [用户体验流程](#用户体验流程)

---

## 🎯 Epic概述

**Epic**: 作为测试工程师，我希望能在测试用例中调用HTTP接口，以便实现UI测试与API测试的结合，提升测试的完整性和准确性。

**业务价值**:
- 支持端到端测试流程，覆盖前后端完整交互
- 动态准备测试数据，减少环境依赖
- 验证UI操作对后端数据的影响
- 提高测试自动化程度和可靠性

---

## 📝 用户故事列表

### Story 1: 基础HTTP请求配置
**作为** 测试工程师  
**我希望** 能够配置HTTP请求的基本参数（方法、URL、请求头、请求体）  
**以便** 在测试中发送API请求获取或提交数据

#### 验收标准
- [ ] **AC1.1**: 支持选择HTTP方法 (GET/POST/PUT/DELETE/PATCH)
- [ ] **AC1.2**: URL输入框支持变量替换，如 `${baseUrl}/api/users/${userId}`
- [ ] **AC1.3**: 请求头支持键值对配置，支持动态变量值
- [ ] **AC1.4**: 请求体支持JSON格式输入，带语法高亮
- [ ] **AC1.5**: 所有配置项都支持变量引用语法 `${variable}`

#### 业务规则
- URL必须是有效的HTTP/HTTPS地址
- 请求头键名不能为空
- POST/PUT/PATCH请求可以包含请求体，GET/DELETE通常不包含
- JSON请求体必须是有效的JSON格式

---

### Story 2: 认证机制支持
**作为** 测试工程师  
**我希望** 能够配置HTTP请求的认证方式  
**以便** 访问需要身份验证的API接口

#### 验收标准
- [ ] **AC2.1**: 支持Bearer Token认证，自动添加到Authorization头
- [ ] **AC2.2**: 支持API Key认证，可配置在Header或Query参数中  
- [ ] **AC2.3**: 支持Basic Auth认证，自动编码用户名密码
- [ ] **AC2.4**: 认证信息支持变量引用，如 `${authToken}`
- [ ] **AC2.5**: 认证失败时提供清晰的错误提示

#### 业务规则
- Bearer Token格式为 `Authorization: Bearer <token>`
- API Key可以是任意的Header名称或Query参数
- Basic Auth自动Base64编码 `username:password`
- 认证信息应当保密，不在日志中明文显示

---

### Story 3: 响应验证和断言
**作为** 测试工程师  
**我希望** 能够验证HTTP响应的内容和状态  
**以便** 确认API调用是否成功并返回预期结果

#### 验收标准
- [ ] **AC3.1**: 支持HTTP状态码断言，验证响应状态是否符合预期
- [ ] **AC3.2**: 支持响应时间断言，检查API响应是否在可接受范围内
- [ ] **AC3.3**: 支持JSON内容断言，使用JSONPath验证响应数据
- [ ] **AC3.4**: 支持响应头断言，验证特定Header的值
- [ ] **AC3.5**: 断言失败时提供详细的错误信息和实际值vs期望值对比

#### 业务规则
- 状态码断言支持精确匹配 (200, 201, 404等)
- 响应时间以毫秒为单位，支持小于、等于、大于比较
- JSONPath断言支持存在性检查、值比较、类型检查
- 所有断言都可以设置为必须通过或警告级别

---

### Story 4: 变量提取和存储
**作为** 测试工程师  
**我希望** 能够从HTTP响应中提取数据并存储为变量  
**以便** 在后续的测试步骤中使用这些数据

#### 验收标准
- [ ] **AC4.1**: 支持使用JSONPath从响应JSON中提取字段值
- [ ] **AC4.2**: 支持提取响应头信息到变量中
- [ ] **AC4.3**: 支持提取响应时间、状态码等元数据
- [ ] **AC4.4**: 提取的变量立即可用于后续步骤
- [ ] **AC4.5**: 变量支持不同数据类型 (字符串、数字、布尔值、对象)

#### 业务规则
- JSONPath表达式必须有效，如 `$.user.id`, `$.items[0].name`
- 如果提取路径不存在，变量值为null，不会中断执行
- 提取的变量名必须是有效的标识符 (字母数字下划线)
- 变量作用域为整个测试用例执行期间

---

### Story 5: 错误处理和重试
**作为** 测试工程师  
**我希望** HTTP请求能够智能处理网络错误和临时故障  
**以便** 提高测试的稳定性和可靠性

#### 验收标准
- [ ] **AC5.1**: 网络连接错误时自动重试，可配置重试次数
- [ ] **AC5.2**: 支持指数退避重试策略，避免过于频繁的重试
- [ ] **AC5.3**: HTTP 5xx错误时可选择重试或立即失败
- [ ] **AC5.4**: 提供详细的错误日志，包含请求和响应详情
- [ ] **AC5.5**: 支持配置超时时间，防止请求无限等待

#### 业务规则
- 默认超时时间为30秒，可配置范围1-300秒
- 默认重试次数为3次，可配置范围0-10次
- 重试间隔采用指数退避: 1s, 2s, 4s, 8s...最大30s
- 4xx错误通常不重试 (客户端错误)
- 5xx错误和网络错误默认重试

---

### Story 6: 步骤编辑器集成
**作为** 测试工程师  
**我希望** HTTP请求步骤能够无缝集成到现有的步骤编辑器中  
**以便** 保持一致的用户体验和操作流程

#### 验收标准
- [ ] **AC6.1**: HTTP步骤在步骤类型选择器中可见
- [ ] **AC6.2**: 配置界面与其他步骤类型风格一致
- [ ] **AC6.3**: 支持步骤拖拽排序和位置调整
- [ ] **AC6.4**: 支持步骤复制、删除等标准操作
- [ ] **AC6.5**: 配置表单支持实时验证和错误提示

#### 业务规则
- HTTP步骤图标使用网络/API相关的视觉标识
- 配置表单按逻辑分组：基本设置、认证、断言、变量提取
- 必填字段有明显的视觉标识
- 配置错误时阻止保存并高亮错误字段

---

### Story 7: 调试和日志查看
**作为** 测试工程师  
**我希望** 能够查看HTTP请求的详细执行日志  
**以便** 调试测试问题和分析执行结果

#### 验收标准
- [ ] **AC7.1**: 执行报告中显示完整的HTTP请求信息
- [ ] **AC7.2**: 显示HTTP响应的状态码、响应头、响应体
- [ ] **AC7.3**: 显示请求耗时的详细分解 (DNS、连接、传输等)
- [ ] **AC7.4**: 显示变量提取的结果和提取过程
- [ ] **AC7.5**: 错误情况下显示详细的错误堆栈和诊断信息

#### 业务规则
- 敏感信息 (如密码、token) 在日志中应当脱敏显示
- 日志按时间顺序组织，便于跟踪执行流程
- 支持日志的展开/折叠，避免界面过于冗长
- 提供复制日志功能，便于问题报告和分析

---

### Story 8: 与AI步骤协作
**作为** 测试工程师  
**我希望** HTTP步骤能够与AI步骤无缝协作  
**以便** 实现复杂的端到端测试场景

#### 验收标准
- [ ] **AC8.1**: HTTP步骤创建的变量可以被AI步骤使用
- [ ] **AC8.2**: AI步骤产生的变量可以用于HTTP请求参数
- [ ] **AC8.3**: 共享浏览器会话状态 (Cookie、Session等)
- [ ] **AC8.4**: 统一的变量作用域和生命周期管理
- [ ] **AC8.5**: 协作执行时的错误隔离和恢复

#### 业务规则
- 变量传递遵循执行顺序，前面的步骤变量对后面可见
- Cookie和Session状态在HTTP和AI步骤间自动共享
- 任一步骤失败时可配置是否终止整个测试用例
- 步骤间的依赖关系应当清晰可见

---

## 🎭 用户体验流程

### 主要用户流程: 创建HTTP步骤测试用例

```
1. 用户进入测试用例编辑页面
   ↓
2. 点击"添加步骤"按钮
   ↓  
3. 在步骤类型选择器中选择"HTTP请求"
   ↓
4. 配置HTTP请求基本参数:
   - 选择请求方法 (POST)
   - 输入URL: ${baseUrl}/api/users
   - 设置Content-Type: application/json
   ↓
5. 配置认证信息:
   - 选择Bearer Token认证
   - 输入Token变量: ${authToken}
   ↓
6. 配置请求体 (JSON):
   {
     "username": "${newUserName}",
     "email": "${newUserEmail}"
   }
   ↓
7. 配置响应断言:
   - 状态码等于201
   - 响应时间小于5秒
   - JSON路径$.id存在
   ↓
8. 配置变量提取:
   - userId = $.id
   - createdAt = $.created_at
   ↓
9. 保存步骤配置
   ↓
10. 执行测试用例，查看执行结果和日志
```

### 错误处理流程

```
HTTP请求执行失败
   ↓
系统判断错误类型:
   ├─ 网络连接错误 → 执行重试策略
   ├─ HTTP 4xx错误 → 记录错误，继续/停止 (根据配置)
   ├─ HTTP 5xx错误 → 可选重试或立即失败
   ├─ 超时错误 → 记录超时，执行重试
   └─ 断言失败 → 记录断言详情，标记步骤失败
   ↓
更新执行状态和错误日志
   ↓
根据错误处理策略决定是否继续后续步骤
```

### 变量使用流程

```
步骤1: AI操作提取页面数据 → 存储变量 baseUrl, authToken
   ↓
步骤2: HTTP请求创建用户
   - 使用变量: POST ${baseUrl}/api/users
   - 使用变量: Authorization: Bearer ${authToken}  
   - 提取变量: userId, userEmail
   ↓
步骤3: AI操作验证页面显示
   - 使用变量: 验证页面是否显示用户ID ${userId}
   ↓
步骤4: HTTP请求验证后端状态
   - 使用变量: GET ${baseUrl}/api/users/${userId}
   - 断言用户状态正确
```

---

## 📊 非功能需求用户故事

### Story 9: 性能需求
**作为** 测试工程师  
**我希望** HTTP请求步骤具有良好的性能表现  
**以便** 不影响整体测试执行效率

#### 验收标准
- [ ] **AC9.1**: 步骤配置界面响应时间 < 500ms
- [ ] **AC9.2**: 一般HTTP请求处理时间 < 30s (可配置)
- [ ] **AC9.3**: 变量提取处理时间 < 1s (对于MB级JSON)
- [ ] **AC9.4**: 支持并发执行多个HTTP请求 (如果测试设计需要)

### Story 10: 可用性需求  
**作为** 非技术背景的测试人员  
**我希望** HTTP步骤配置简单易懂  
**以便** 快速上手使用该功能

#### 验收标准
- [ ] **AC10.1**: 提供常用配置的预设模板
- [ ] **AC10.2**: 关键字段提供内联帮助和示例
- [ ] **AC10.3**: 配置错误时提供建议修复方案
- [ ] **AC10.4**: 支持配置导入导出，便于团队共享

### Story 11: 兼容性需求
**作为** 系统管理员  
**我希望** HTTP步骤功能与现有系统完全兼容  
**以便** 平滑升级和部署

#### 验收标准
- [ ] **AC11.1**: 与现有所有浏览器类型兼容
- [ ] **AC11.2**: 不影响现有AI步骤的执行
- [ ] **AC11.3**: 向后兼容，旧测试用例正常执行
- [ ] **AC11.4**: 支持现有的部署和配置方式

---

## ✅ 整体验收标准

### 功能完整性检查
- [ ] 所有基础HTTP方法 (GET/POST/PUT/DELETE/PATCH) 均可正常执行
- [ ] 认证机制 (Bearer Token, API Key, Basic Auth) 功能正常
- [ ] 响应断言 (状态码、时间、内容、头部) 准确可靠
- [ ] 变量提取和使用在不同数据类型下均正常工作
- [ ] 错误处理和重试机制在各种异常情况下表现正确

### 集成性检查  
- [ ] 与现有步骤编辑器完美集成，用户体验一致
- [ ] 与AI步骤的变量共享和协作功能正常
- [ ] 执行报告和日志记录完整准确
- [ ] WebSocket实时更新功能正常工作

### 用户体验检查
- [ ] 新用户能在10分钟内完成基础HTTP请求配置
- [ ] 错误信息清晰明确，提供可操作的解决建议  
- [ ] 调试信息丰富详细，便于问题定位
- [ ] 配置界面响应迅速，操作流畅

### 稳定性检查
- [ ] 网络异常情况下的错误处理和恢复
- [ ] 大量并发请求时的系统稳定性
- [ ] 长时间运行测试的内存和性能表现
- [ ] 各种边界条件下的异常处理

---

*本用户故事文档将根据用户反馈和测试结果持续完善和更新*