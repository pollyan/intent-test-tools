{% extends "base_layout.html" %}

{% block title %}测试用例管理 - AI测试系统{% endblock %}

{% block page_title %}测试用例管理{% endblock %}

{% block page_subtitle %}创建、管理和执行测试用例{% endblock %}

{% block extra_css %}
<style>
    /* 移除旧的测试用例样式，使用统一的list样式 */

    /* 空状态样式 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999999;
    }


    .empty-text {
        font-size: 16px;
        margin-bottom: 8px;
    }

    .empty-desc {
        font-size: 14px;
        color: #bbbbbb;
    }

    /* 加载状态样式 */
    .loading {
        text-align: center;
        padding: 40px;
        color: #999999;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f0f0f0;
        border-top: 2px solid #333333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 状态指示器样式增强 */
    .status {
        cursor: help;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .status:hover {
        transform: scale(1.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* 状态指示器tooltip样式 */
    .status[title] {
        position: relative;
    }
    
    /* 测试用例项目点击效果样式 */
    .list-item {
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    
    .list-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
    }
    
    .list-item:active {
        transform: translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<!-- 操作栏 -->
<div class="card mb-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <a href="/testcases/create" class="btn btn-primary">创建用例</a>
            <button class="btn btn-ghost" onclick="importTestCases()" disabled>导入用例</button>
            <button class="btn btn-ghost" onclick="batchOperations()" disabled>批量操作</button>
        </div>
        <div class="text-sm text-gray-600" id="total-count">
            共 0 个测试用例
        </div>
    </div>
</div>

<!-- 筛选器 -->
<div class="card mb-3">
    <div class="grid grid-cols-4 gap-2">
        <div class="form-group mb-0">
            <label class="form-label">搜索</label>
            <input type="text" id="search" class="form-input" placeholder="搜索测试用例...">
        </div>
        <div class="form-group mb-0">
            <label class="form-label">分类</label>
            <select id="category" class="form-select">
                <option value="">全部分类</option>
                <option value="功能测试">功能测试</option>
                <option value="性能测试">性能测试</option>
                <option value="兼容性测试">兼容性测试</option>
                <option value="安全测试">安全测试</option>
            </select>
        </div>
        <div class="form-group mb-0">
            <label class="form-label">优先级</label>
            <select id="priority" class="form-select">
                <option value="">全部优先级</option>
                <option value="1">高</option>
                <option value="2">中</option>
                <option value="3">低</option>
            </select>
        </div>
        <div class="form-group mb-0">
            <label class="form-label">状态</label>
            <select id="status" class="form-select">
                <option value="">全部状态</option>
                <option value="活跃">活跃</option>
                <option value="暂停">暂停</option>
                <option value="草稿">草稿</option>
            </select>
        </div>
    </div>
</div>

<!-- 测试用例列表 -->
<div class="card">
    <div class="card-title">测试用例列表</div>
    <div class="card-subtitle">当前筛选结果</div>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        正在加载测试用例...
    </div>
    
    <div id="testcase-items" class="list">
        <!-- 测试用例项目会在这里动态加载 -->
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-text">暂无测试用例</div>
        <div class="empty-desc">点击"创建用例"按钮开始创建您的第一个测试用例</div>
    </div>

    <!-- 分页 -->
    <div class="divider" id="pagination-divider" style="display: none;"></div>
    <div id="pagination" class="flex items-center justify-between" style="display: none;">
        <div class="text-sm text-gray-600" id="pagination-info">
            显示 1-10 条，共 0 条记录
        </div>
        <div class="flex items-center gap-1" id="pagination-controls">
            <!-- 分页控件会在这里动态生成 -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let pageSize = 10;
    let totalItems = 0;
    let totalPages = 0;
    
    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadTestCases();
        
        // 搜索框回车搜索
        document.getElementById('search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        
        // 筛选器变化时立即触发筛选
        document.getElementById('category').addEventListener('change', applyFilters);
        document.getElementById('priority').addEventListener('change', applyFilters);
        document.getElementById('status').addEventListener('change', applyFilters);
        
        // 搜索框输入时实时筛选（可选，防抖处理）
        let searchTimeout;
        document.getElementById('search').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 500); // 500ms防抖
        });
    });
    
    // 加载测试用例列表
    async function loadTestCases(page = 1) {
        try {
            showLoading(true);
            
            const search = document.getElementById('search').value;
            const category = document.getElementById('category').value;
            const priority = document.getElementById('priority').value;
            const status = document.getElementById('status').value;
            
            const params = new URLSearchParams({
                page: page,
                size: pageSize
            });
            
            if (search) params.append('search', search);
            if (category) params.append('category', category);
            if (priority) params.append('priority', priority);
            if (status) params.append('status', status);
            
            const response = await axios.get(`/api/testcases?${params}`);
            
            if (response.data.code === 200) {
                const data = response.data.data;
                totalItems = data.total;
                totalPages = data.pages;
                currentPage = data.page;
                
                renderTestCases(data.items);
                renderPagination();
                
                // 更新总数显示
                document.getElementById('total-count').textContent = `共 ${totalItems} 个测试用例`;
                
                if (data.items.length === 0) {
                    showEmptyState();
                }
            } else {
                showMessage(response.data.message || '加载失败', 'error');
            }
        } catch (error) {
            console.error('加载测试用例失败:', error);
            showMessage('加载测试用例失败', 'error');
        } finally {
            showLoading(false);
        }
    }
    
    // 渲染测试用例列表
    function renderTestCases(testcases) {
        const container = document.getElementById('testcase-items');
        container.innerHTML = '';
        
        testcases.forEach(testcase => {
            const item = createTestCaseItem(testcase);
            container.appendChild(item);
        });
    }
    
    // 创建测试用例项目
    function createTestCaseItem(testcase) {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.title = '点击进入编辑模式';  // 添加提示文本
        item.onclick = () => editTestCase(testcase.id);
        
        const steps = testcase.steps || [];
        const stepCount = steps.length;
        
        // 获取执行统计数据
        const executionCount = testcase.execution_count || 0;
        const successRate = testcase.success_rate || 0;
        
        // 获取状态样式和文本
        const statusText = testcase.status || '活跃';
        const statusClass = getStatusClass(statusText);
        
        item.innerHTML = `
            <div class="list-item-content">
                <div class="list-item-title">${testcase.name}</div>
                <div class="list-item-subtitle">${testcase.description || '暂无描述'}</div>
                <div class="list-item-meta">
                    <span class="text-gray-600">${testcase.category || '未分类'}</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">${getPriorityText(testcase.priority)}优先级</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">${stepCount}个步骤</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">创建于 ${new Date(testcase.created_at).toLocaleDateString()}</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">执行${executionCount}次</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">成功率 ${successRate}%</span>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button class="btn btn-small btn-ghost" onclick="event.stopPropagation(); editTestCase(${testcase.id})">编辑</button>
                <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); executeTestCase(${testcase.id})">执行</button>
                <button class="btn btn-small btn-ghost" onclick="event.stopPropagation(); deleteTestCase(${testcase.id})">删除</button>
                <div class="status ${statusClass}" title="${getStatusDescription(statusText)}"></div>
            </div>
        `;
        
        return item;
    }
    
    // 获取优先级文本
    function getPriorityText(priority) {
        switch(priority) {
            case 1: return '高';
            case 2: return '中';
            case 3: return '低';
            default: return '未设置';
        }
    }
    
    // 获取状态样式类
    function getStatusClass(status) {
        switch(status) {
            case '活跃': return 'status-success';
            case '暂停': return 'status-warning';
            case '草稿': return 'status-error';
            default: return 'status-success';
        }
    }
    
    // 获取状态详细描述
    function getStatusDescription(status) {
        switch(status) {
            case '活跃': return '状态: 活跃 - 测试用例正常运行，可以执行测试';
            case '暂停': return '状态: 暂停 - 测试用例已暂停，暂时不可执行';
            case '草稿': return '状态: 草稿 - 测试用例尚未完成，处于编辑状态';
            default: return '状态: 活跃 - 测试用例正常运行，可以执行测试';
        }
    }
    
    // 渲染分页控件
    function renderPagination() {
        const container = document.getElementById('pagination');
        const divider = document.getElementById('pagination-divider');
        const info = document.getElementById('pagination-info');
        const controls = document.getElementById('pagination-controls');
        
        if (totalPages <= 1) {
            container.style.display = 'none';
            divider.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        divider.style.display = 'block';
        
        // 更新记录信息
        const startRecord = (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, totalItems);
        info.textContent = `显示 ${startRecord}-${endRecord} 条，共 ${totalItems} 条记录`;
        
        // 生成分页按钮
        let paginationHTML = '';
        
        // 上一页按钮
        paginationHTML += `<button class="btn btn-small btn-ghost ${currentPage === 1 ? 'disabled' : ''}" 
                                  onclick="loadTestCases(${currentPage - 1})" 
                                  ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;
        
        // 页码按钮
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === currentPage;
            paginationHTML += `<button class="btn btn-small ${isActive ? 'btn-primary' : 'btn-ghost'}" 
                                      onclick="loadTestCases(${i})">${i}</button>`;
        }
        
        // 下一页按钮
        paginationHTML += `<button class="btn btn-small btn-ghost ${currentPage === totalPages ? 'disabled' : ''}" 
                                  onclick="loadTestCases(${currentPage + 1})" 
                                  ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
        
        controls.innerHTML = paginationHTML;
    }
    
    // 显示加载状态
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
        document.getElementById('testcase-items').style.display = show ? 'none' : 'block';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('pagination').style.display = show ? 'none' : 'flex';
    }
    
    // 显示空状态
    function showEmptyState() {
        document.getElementById('empty-state').style.display = 'block';
        document.getElementById('testcase-items').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }
    
    // 应用筛选
    function applyFilters() {
        currentPage = 1;
        loadTestCases(1);
    }
    
    // 刷新列表
    function refreshList() {
        loadTestCases(currentPage);
    }
    
    // 编辑测试用例
    function editTestCase(id) {
        window.location.href = `/testcases/${id}/edit`;
    }
    
    // 执行测试用例
    function executeTestCase(id) {
        window.location.href = `/execution?testcase_id=${id}`;
    }
    
    // 导入测试用例
    function importTestCases() {
        // 创建文件输入元素
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // 这里可以添加导入逻辑
                        showMessage('导入功能待实现', 'info');
                    } catch (error) {
                        showMessage('文件格式错误', 'error');
                    }
                };
                reader.readAsText(file);
            }
        };
        fileInput.click();
    }
    
    // 批量操作
    function batchOperations() {
        showMessage('批量操作功能待实现', 'info');
    }
    
    // 查看测试用例
    function viewTestCase(id) {
        window.location.href = `/testcases/${id}`;
    }
    
    // 删除测试用例
    async function deleteTestCase(id) {
        if (!confirm('确定要删除这个测试用例吗？此操作不可恢复。')) {
            return;
        }
        
        try {
            const response = await axios.delete(`/api/testcases/${id}`);
            
            if (response.data.code === 200) {
                showMessage('测试用例删除成功', 'success');
                loadTestCases(currentPage);
            } else {
                showMessage(response.data.message || '删除失败', 'error');
            }
        } catch (error) {
            console.error('删除测试用例失败:', error);
            // 显示更详细的错误信息
            if (error.response) {
                // 服务器返回了错误响应
                console.error('错误响应数据:', error.response.data);
                console.error('错误响应状态:', error.response.status);
                showMessage(`删除失败: ${error.response.data.message || error.response.statusText}`, 'error');
            } else if (error.request) {
                // 请求已发送但没有收到响应
                console.error('请求未收到响应:', error.request);
                showMessage('删除失败: 服务器无响应', 'error');
            } else {
                // 其他错误
                console.error('请求配置错误:', error.message);
                showMessage(`删除失败: ${error.message}`, 'error');
            }
        }
    }
</script>
{% endblock %}