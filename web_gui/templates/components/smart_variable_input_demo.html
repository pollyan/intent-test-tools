<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartVariableInput 智能变量输入组件演示</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/smart-variable-input.css') }}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .demo-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        
        .demo-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
        }
        
        .demo-description {
            color: #6b7280;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .demo-input-group {
            margin-bottom: 20px;
        }
        
        .demo-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .demo-input-group input {
            width: 100%;
            max-width: 400px;
        }
        
        .keyboard-shortcuts {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .keyboard-shortcuts h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
        }
        
        .shortcut-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .shortcut-list li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .shortcut-key {
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #374151;
        }
        
        .status-display {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 13px;
            color: #6b7280;
        }
        
        .logs {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>SmartVariableInput 智能变量输入组件演示</h1>
    <p>这个页面演示了SmartVariableInput组件的各项功能，包括智能提示、嵌套属性、键盘导航等。</p>

    <div class="demo-section">
        <div class="demo-title">基础变量输入</div>
        <div class="demo-description">
            输入 <code>${</code> 触发智能提示。支持模糊搜索，大小写不敏感。
        </div>
        <div class="demo-input-group">
            <label for="basic-input">参数值</label>
            <input type="text" id="basic-input" placeholder="尝试输入 ${" />
        </div>
        
        <div class="keyboard-shortcuts">
            <h4>键盘快捷键</h4>
            <ul class="shortcut-list">
                <li><span class="shortcut-key">↑ ↓</span> 上下选择变量</li>
                <li><span class="shortcut-key">Enter</span> 确认选择</li>
                <li><span class="shortcut-key">Tab</span> 快速选择第一项</li>
                <li><span class="shortcut-key">ESC</span> 关闭提示菜单</li>
                <li><span class="shortcut-key">Ctrl+Space</span> 强制打开提示</li>
            </ul>
        </div>
    </div>

    <div class="demo-section">
        <div class="demo-title">嵌套属性智能提示</div>
        <div class="demo-description">
            当你输入对象变量名后的点号（如 <code>${product_info.</code>），会显示该对象的可用属性。
        </div>
        <div class="demo-input-group">
            <label for="nested-input">嵌套属性</label>
            <input type="text" id="nested-input" placeholder="尝试输入 ${product_info." />
        </div>
    </div>

    <div class="demo-section">
        <div class="demo-title">多变量引用</div>
        <div class="demo-description">
            在同一个输入框中可以引用多个变量。每个 <code>${}</code> 块都会独立提供智能提示。
        </div>
        <div class="demo-input-group">
            <label for="multiple-input">多变量引用</label>
            <input type="text" id="multiple-input" placeholder="例如：查询${user_name}的${product_info.name}" />
        </div>
    </div>

    <div class="demo-section">
        <div class="demo-title">实时状态监控</div>
        <div class="demo-description">
            查看组件的内部状态和事件日志。
        </div>
        
        <div class="status-display">
            <div><strong>当前状态:</strong></div>
            <div id="status-context">Context: null</div>
            <div id="status-suggestions">Suggestions: 0</div>
            <div id="status-selected">Selected Index: -1</div>
            <div id="status-filter">Filter Text: ""</div>
        </div>
        
        <div class="logs" id="event-logs">
            <!-- 事件日志将在这里显示 -->
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/smart-variable-input.js') }}"></script>
    <script>
        // 模拟的执行ID（在实际使用中应该从后端获取）
        const DEMO_EXECUTION_ID = 'demo-execution-123';
        
        // 模拟的变量数据
        const MOCK_VARIABLES = [
            {
                name: 'user_name',
                data_type: 'string',
                preview: '"张三"',
                source_step_index: 1
            },
            {
                name: 'user_age',
                data_type: 'number',
                preview: '28',
                source_step_index: 1
            },
            {
                name: 'product_info',
                data_type: 'object',
                preview: '{name: "iPhone 15", price: 999, category: "电子产品"}',
                source_step_index: 2
            },
            {
                name: 'product_list',
                data_type: 'array',
                preview: '[{name: "iPhone"}, {name: "iPad"}]',
                source_step_index: 2
            },
            {
                name: 'order_total',
                data_type: 'number',
                preview: '1299.99',
                source_step_index: 3
            },
            {
                name: 'is_premium_user',
                data_type: 'boolean',
                preview: 'true',
                source_step_index: 1
            }
        ];
        
        // 模拟的属性数据
        const MOCK_PROPERTIES = {
            'product_info': [
                { name: 'name', type: 'string', value: '"iPhone 15"' },
                { name: 'price', type: 'number', value: 999 },
                { name: 'category', type: 'string', value: '"电子产品"' },
                { name: 'stock', type: 'number', value: 100 },
                { name: 'description', type: 'string', value: '"最新款智能手机"' }
            ],
            'product_list': [
                { name: 'length', type: 'number', value: 2 },
                { name: '0', type: 'object', value: '{name: "iPhone"}' },
                { name: '1', type: 'object', value: '{name: "iPad"}' }
            ]
        };
        
        // 模拟fetch API
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            console.log('Intercepted fetch:', url);
            
            if (url.includes('/variable-suggestions')) {
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve({ variables: MOCK_VARIABLES })
                });
            }
            
            if (url.includes('/variables/') && url.includes('/properties')) {
                const variableName = url.split('/variables/')[1].split('/properties')[0];
                const properties = MOCK_PROPERTIES[variableName] || [];
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve({ properties })
                });
            }
            
            // 如果不是我们要拦截的请求，使用原始fetch
            return originalFetch.apply(this, arguments);
        };
        
        // 日志系统
        function addLog(message) {
            const logs = document.getElementById('event-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        // 状态更新
        function updateStatus(component) {
            document.getElementById('status-context').textContent = 
                `Context: ${JSON.stringify(component.currentContext)}`;
            document.getElementById('status-suggestions').textContent = 
                `Suggestions: ${component.suggestions.length}`;
            document.getElementById('status-selected').textContent = 
                `Selected Index: ${component.selectedIndex}`;
            document.getElementById('status-filter').textContent = 
                `Filter Text: "${component.filterText}"`;
        }
        
        // 创建智能输入组件
        function createDemoComponent(selector, label) {
            const component = createSmartVariableInput(selector, {
                executionId: DEMO_EXECUTION_ID,
                onChange: (value) => {
                    addLog(`${label} 值已更改: ${value}`);
                }
            });
            
            if (!component) {
                console.error('Failed to create component for', selector);
                return null;
            }
            
            // 监听内部状态变化
            const originalLoadSuggestions = component.loadSuggestions.bind(component);
            component.loadSuggestions = async function() {
                addLog(`${label} 开始加载建议...`);
                await originalLoadSuggestions();
                addLog(`${label} 加载了 ${this.suggestions.length} 个建议`);
                updateStatus(this);
            };
            
            const originalInsertSelectedVariable = component.insertSelectedVariable.bind(component);
            component.insertSelectedVariable = function() {
                const selectedItem = this.filteredSuggestions[this.selectedIndex];
                if (selectedItem) {
                    addLog(`${label} 插入变量: ${selectedItem.name}`);
                }
                originalInsertSelectedVariable();
                updateStatus(this);
            };
            
            const originalHideSuggestions = component.hideSuggestions.bind(component);
            component.hideSuggestions = function() {
                addLog(`${label} 隐藏建议菜单`);
                originalHideSuggestions();
                updateStatus(this);
            };
            
            return component;
        }
        
        // 页面加载完成后初始化组件
        document.addEventListener('DOMContentLoaded', function() {
            addLog('页面加载完成，初始化组件...');
            
            const basicComponent = createDemoComponent('#basic-input', '基础输入');
            const nestedComponent = createDemoComponent('#nested-input', '嵌套输入');
            const multipleComponent = createDemoComponent('#multiple-input', '多变量输入');
            
            if (basicComponent) {
                updateStatus(basicComponent);
                addLog('所有组件初始化完成');
            }
            
            // 添加一些使用提示
            addLog('提示：输入 ${ 可以触发智能提示');
            addLog('提示：尝试输入 ${product_info. 查看嵌套属性');
            addLog('提示：使用键盘方向键导航，回车键确认选择');
        });
    </script>
</body>
</html>