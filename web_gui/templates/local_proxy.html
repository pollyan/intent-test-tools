{% extends "base_layout.html" %}

{% block title %}æœ¬åœ°ä»£ç†ä¸‹è½½ - AIæµ‹è¯•ç³»ç»Ÿ{% endblock %}

{% block page_title %}æœ¬åœ°ä»£ç†ä¸‹è½½{% endblock %}

{% block extra_css %}
<style>
    /* çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-radius: 4px;
        margin-bottom: 16px;
        font-size: 14px;
        border: 1px solid #e8e8e8;
        background: #f8f8f8;
        color: #666666;
    }

    .status-indicator.checking {
        background: #fff7e6;
        border-color: #ffd591;
        color: #d48806;
    }

    .status-indicator.connected {
        background: #f6ffed;
        border-color: #b7eb8f;
        color: #389e0d;
    }

    .status-indicator.disconnected {
        background: #fff2f0;
        border-color: #ffb3b3;
        color: #cf1322;
    }

    .status-light {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .status-light.checking {
        background: #fadb14;
        animation: pulse 2s infinite;
    }

    .status-light.connected {
        background: #52c41a;
        animation: pulse 2s infinite;
    }

    .status-light.disconnected {
        background: #ff4d4f;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            opacity: 0.7;
        }
        50% {
            transform: scale(1.05);
            opacity: 1;
        }
        100% {
            transform: scale(0.95);
            opacity: 0.7;
        }
    }

    /* æ­¥éª¤æ ·å¼ */
    .step-list {
        list-style: none;
        padding: 0;
    }

    .step-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 16px;
        padding: 16px;
        border-radius: 4px;
        background: #f8f8f8;
        border-left: 4px solid #333333;
        border: 1px solid #e8e8e8;
    }

    .step-number {
        background: #333333;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        font-size: 12px;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .step-content {
        flex: 1;
    }

    .step-title {
        font-weight: 500;
        margin-bottom: 4px;
        color: #333333;
    }

    .step-description {
        color: #666666;
        line-height: 1.5;
        font-size: 14px;
    }

    /* ä»£ç å—æ ·å¼ */
    .code-block {
        background: #f8f8f8;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 8px;
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 13px;
        color: #333333;
        overflow-x: auto;
    }

    /* ç³»ç»Ÿè¦æ±‚æ ·å¼ */
    .system-requirements {
        background: #f8f8f8;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .requirements-title {
        font-weight: 500;
        margin-bottom: 8px;
        color: #333333;
    }

    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .requirements-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        font-size: 14px;
        color: #666666;
    }


    /* ç‰ˆæœ¬ä¿¡æ¯æ ·å¼ */
    .version-info {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 12px;
        font-size: 12px;
        color: #999999;
    }

    .version-badge {
        padding: 2px 6px;
        background: #f0f0f0;
        border-radius: 4px;
        font-family: 'SF Mono', Monaco, monospace;
        color: #333333;
    }

    /* ä¸‹è½½æ“ä½œæ ·å¼ */
    .download-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .download-description {
        color: #666666;
        margin-bottom: 20px;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<!-- é‡è¦æç¤º -->
<div class="card mb-3">
    <div class="flex items-start">
        <div>
            <strong>é‡è¦æç¤ºï¼š</strong>æœ¬åœ°ä»£ç†æœåŠ¡å™¨æ˜¯è¿›è¡ŒAIæµ‹è¯•çš„å¿…å¤‡ç»„ä»¶ã€‚
            å¦‚æœæ‚¨éœ€è¦åœ¨æœ¬åœ°è°ƒè¯•å’Œæ‰§è¡Œæµ‹è¯•è„šæœ¬ï¼Œè¯·åŠ¡å¿…ä¸‹è½½å¹¶è¿è¡Œæœ¬åœ°ä»£ç†æœåŠ¡å™¨ã€‚
            äº‘ç«¯æ‰§è¡Œä¸éœ€è¦æœ¬åœ°ä»£ç†ï¼Œä½†åŠŸèƒ½ä¼šå—åˆ°ä¸€å®šé™åˆ¶ã€‚
        </div>
    </div>
</div>

<!-- è¿æ¥çŠ¶æ€æ£€æŸ¥ -->
<div class="card mb-3">
    <div class="flex items-center mb-3">
        <span class="text-xl mr-2">ğŸ”—</span>
        <h3 class="card-title mb-0">è¿æ¥çŠ¶æ€</h3>
    </div>
    
    <div id="connection-status" class="status-indicator checking">
        <span class="status-light checking"></span>
        <span>æ­£åœ¨æ£€æŸ¥æœ¬åœ°ä»£ç†æœåŠ¡å™¨è¿æ¥çŠ¶æ€...</span>
    </div>
    
    <button id="check-connection" class="btn btn-ghost" onclick="checkConnection()">
        <span>ğŸ”„</span>
        é‡æ–°æ£€æŸ¥
    </button>
</div>

<!-- ä¸‹è½½åŒºåŸŸ -->
<div class="card mb-3">
    <div class="flex items-center mb-3">
        <h3 class="card-title mb-0">ä¸‹è½½æœ¬åœ°ä»£ç†åŒ…</h3>
    </div>
    
    <div class="download-description">
        æœ¬åœ°ä»£ç†åŒ…åŒ…å«äº†å®Œæ•´çš„AIæµ‹è¯•æ‰§è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬MidSceneJSå¼•æ“ã€æµè§ˆå™¨é©±åŠ¨å’Œæ‰€æœ‰å¿…è¦çš„ä¾èµ–ã€‚
        ä¸‹è½½åæ— éœ€é¢å¤–å®‰è£…ï¼Œå¯ç›´æ¥è¿è¡Œã€‚
    </div>
    
    <div class="system-requirements">
        <div class="requirements-title">ç³»ç»Ÿè¦æ±‚</div>
        <ul class="requirements-list">
            <li class="requirements-item">
                Node.js 18.0 æˆ–æ›´é«˜ç‰ˆæœ¬
            </li>
            <li class="requirements-item">
                æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼šWindowsã€macOSã€Linux
            </li>
            <li class="requirements-item">
                è‡³å°‘ 2GB å¯ç”¨ç£ç›˜ç©ºé—´
            </li>
            <li class="requirements-item">
                ç½‘ç»œè¿æ¥ï¼ˆç”¨äºAIæ¨¡å‹APIè°ƒç”¨ï¼‰
            </li>
        </ul>
    </div>
    
    <div class="download-actions">
        <a href="/api/download-proxy" class="btn btn-primary" id="download-btn">
            ç«‹å³ä¸‹è½½
        </a>
        <button class="btn btn-ghost" onclick="checkVersion()">
            æ£€æŸ¥ç‰ˆæœ¬
        </button>
    </div>
    
    <div class="version-info">
        <span>å½“å‰ç‰ˆæœ¬ï¼š</span>
        <span class="version-badge" id="current-version">v1.0.0</span>
        <span>æ›´æ–°æ—¥æœŸï¼š</span>
        <span id="update-date">{{ current_date }}</span>
    </div>
</div>

<!-- ä½¿ç”¨è¯´æ˜ -->
<div class="card">
    <div class="flex items-center mb-3">
        <h3 class="card-title mb-0">ä½¿ç”¨è¯´æ˜</h3>
    </div>
    
    <ol class="step-list">
        <li class="step-item">
            <div class="step-number">1</div>
            <div class="step-content">
                <div class="step-title">ä¸‹è½½ä»£ç†åŒ…</div>
                <div class="step-description">
                    ç‚¹å‡»ä¸Šæ–¹"ç«‹å³ä¸‹è½½"æŒ‰é’®ï¼Œä¸‹è½½æœ€æ–°çš„æœ¬åœ°ä»£ç†åŒ…å‹ç¼©æ–‡ä»¶ã€‚
                </div>
            </div>
        </li>
        
        <li class="step-item">
            <div class="step-number">2</div>
            <div class="step-content">
                <div class="step-title">è§£å‹æ–‡ä»¶</div>
                <div class="step-description">
                    å°†ä¸‹è½½çš„å‹ç¼©æ–‡ä»¶è§£å‹åˆ°æ‚¨é€‰æ‹©çš„ç›®å½•ä¸­ã€‚
                    <div class="code-block">
                        # Windows
                        å³é”® â†’ è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹
                        
                        # macOS/Linux
                        unzip local-proxy-package.zip
                    </div>
                </div>
            </div>
        </li>
        
        <li class="step-item">
            <div class="step-number">3</div>
            <div class="step-content">
                <div class="step-title">é…ç½®ç¯å¢ƒå˜é‡</div>
                <div class="step-description">
                    åœ¨è§£å‹åçš„ç›®å½•ä¸­æ‰¾åˆ° .env.example æ–‡ä»¶ï¼Œå¤åˆ¶ä¸º .env å¹¶é…ç½®æ‚¨çš„AIæ¨¡å‹APIå¯†é’¥ã€‚
                    <div class="code-block">
                        # å¤åˆ¶é…ç½®æ–‡ä»¶
                        cp .env.example .env
                        
                        # ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®æ‚¨çš„APIå¯†é’¥
                        OPENAI_API_KEY=sk-your-api-key
                        OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
                        MIDSCENE_MODEL_NAME=qwen-vl-max-latest
                    </div>
                </div>
            </div>
        </li>
        
        <li class="step-item">
            <div class="step-number">4</div>
            <div class="step-content">
                <div class="step-title">å¯åŠ¨æœåŠ¡</div>
                <div class="step-description">
                    ä½¿ç”¨æä¾›çš„å¯åŠ¨è„šæœ¬å¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ã€‚
                    <div class="code-block">
                        # Windows
                        start.bat
                        
                        # macOS/Linux
                        ./start.sh
                    </div>
                </div>
            </div>
        </li>
        
        <li class="step-item">
            <div class="step-number">5</div>
            <div class="step-content">
                <div class="step-title">éªŒè¯è¿æ¥</div>
                <div class="step-description">
                    å¯åŠ¨æˆåŠŸåï¼Œæœ¬é¡µé¢çš„è¿æ¥çŠ¶æ€åº”è¯¥æ˜¾ç¤ºä¸º"å·²è¿æ¥"ã€‚
                    å¦‚æœæ˜¾ç¤ºè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œç«¯å£3001æ˜¯å¦è¢«å ç”¨ã€‚
                </div>
            </div>
        </li>
    </ol>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let connectionCheckInterval;
    
    // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ£€æŸ¥è¿æ¥
    document.addEventListener('DOMContentLoaded', function() {
        checkConnection();
        // æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡è¿æ¥çŠ¶æ€
        connectionCheckInterval = setInterval(checkConnection, 30000);
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
        if (connectionCheckInterval) {
            clearInterval(connectionCheckInterval);
        }
    });
    
    // æ£€æŸ¥è¿æ¥çŠ¶æ€
    async function checkConnection() {
        const statusElement = document.getElementById('connection-status');
        const statusLight = statusElement.querySelector('.status-light');
        const statusText = statusElement.querySelector('span:last-child');
        
        // è®¾ç½®æ£€æŸ¥çŠ¶æ€
        statusElement.className = 'status-indicator checking';
        statusLight.className = 'status-light checking';
        statusText.textContent = 'æ­£åœ¨æ£€æŸ¥æœ¬åœ°ä»£ç†æœåŠ¡å™¨è¿æ¥çŠ¶æ€...';
        
        try {
            const response = await fetch('http://localhost:3001/health', {
                method: 'GET',
                timeout: 5000
            });
            
            if (response.ok) {
                // è¿æ¥æˆåŠŸ
                statusElement.className = 'status-indicator connected';
                statusLight.className = 'status-light connected';
                statusText.textContent = 'æœ¬åœ°ä»£ç†æœåŠ¡å™¨è¿æ¥æ­£å¸¸ (http://localhost:3001)';
            } else {
                throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
            }
        } catch (error) {
            // è¿æ¥å¤±è´¥
            statusElement.className = 'status-indicator disconnected';
            statusLight.className = 'status-light disconnected';
            statusText.textContent = 'æœ¬åœ°ä»£ç†æœåŠ¡å™¨æœªè¿æ¥ - è¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨å¹¶è¿è¡Œåœ¨ç«¯å£3001';
        }
    }
    
    // æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
    async function checkVersion() {
        try {
            const response = await axios.get('/api/proxy-version');
            if (response.data.code === 200) {
                const versionInfo = response.data.data;
                document.getElementById('current-version').textContent = versionInfo.version;
                document.getElementById('update-date').textContent = versionInfo.date;
                showMessage('ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°', 'success');
            }
        } catch (error) {
            console.error('è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', error);
            showMessage('è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥', 'error');
        }
    }
    
    // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('download-btn').addEventListener('click', function(e) {
        // æ·»åŠ ä¸‹è½½ç»Ÿè®¡
        if (typeof gtag !== 'undefined') {
            gtag('event', 'download', {
                event_category: 'proxy',
                event_label: 'local-proxy-package'
            });
        }
        
        showMessage('å¼€å§‹ä¸‹è½½æœ¬åœ°ä»£ç†åŒ…...', 'info');
    });
</script>
{% endblock %}